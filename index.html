
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>French Verbs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-card: #ffffff;
      --bg-soft: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #e0ecff;
      --danger: #ef4444;
      --success: #16a34a;
      --border: #e5e7eb;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 16px 40px rgba(15, 23, 42, 0.18);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      height: 100%;
    }
    body {
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 430px;
      min-height: 100vh;
      background: linear-gradient(to bottom, #eef2ff 0, #f9fafb 80%);
      padding-bottom: env(safe-area-inset-bottom, 16px);
    }
    header {
      padding: 18px 20px 10px 20px;
    }
    header h1 {
      margin: 0;
      text-align: center;
      font-size: 22px;
      letter-spacing: 0.06em;
      text-transform: lowercase;
      color: #1d4ed8;
    }
    header small {
      display: block;
      text-align: center;
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }
    main {
      padding: 0 16px 16px 16px;
    }
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin: 10px 4px 6px 4px;
    }
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin-bottom: 12px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-header h2 {
      margin: 0;
      font-size: 16px;
    }
    .card-header span {
      font-size: 12px;
      color: var(--text-muted);
    }
    .mode-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 8px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.15s ease, transform 0.08s ease;
    }
    .mode-row:hover {
      background: #f3f4ff;
      transform: translateY(-1px);
    }
    .mode-row + .mode-row {
      border-top: 1px solid var(--border);
    }
    .mode-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .mode-icon {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: #dbeafe;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #1d4ed8;
      flex-shrink: 0;
    }
    .mode-text-title {
      font-size: 14px;
      font-weight: 600;
    }
    .mode-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }
    .mode-chevron {
      font-size: 16px;
      color: var(--text-muted);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--bg-soft);
      border: 1px solid #e5e7eb;
      font-size: 11px;
      color: var(--text-muted);
    }
    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .days-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 10px;
    }
    .day-dot {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-muted);
      background: #f3f4ff;
    }
    .day-dot.active {
      background: #1d4ed8;
      color: #eff6ff;
      font-weight: 600;
    }
    .streak-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .streak-card {
      flex: 1;
      background: var(--bg-soft);
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
    }
    .streak-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .streak-value {
      font-size: 18px;
      font-weight: 600;
    }
    .today-progress {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .circle {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 4px solid #e5e7eb;
      border-top-color: #2563eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }
    .today-text {
      font-size: 13px;
    }
    .today-sub {
      font-size: 12px;
      color: var(--text-muted);
    }
    .chart-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }
    .chart-tab {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      background: transparent;
    }
    .chart-tab.active {
      border-color: #c7d2fe;
      background: #e0ecff;
      color: #1d4ed8;
    }
    .chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      height: 120px;
      gap: 6px;
      padding: 4px 0;
    }
    .bar-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }
    .bar-stack {
      width: 14px;
      height: 100%;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      display: flex;
      flex-direction: column-reverse;
    }
    .bar-seg {
      width: 100%;
      transition: height 0.2s ease;
    }
    .bar-new {
      background: linear-gradient(to top, #f97316, #fde68a);
    }
    .bar-review {
      background: linear-gradient(to top, #60a5fa, #bfdbfe);
    }
    .bar-label {
      font-size: 10px;
      color: var(--text-muted);
    }
    .legend-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 11px;
      color: var(--text-muted);
    }
    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      margin-right: 4px;
      display: inline-block;
    }
    .legend-new { background: #f97316; }
    .legend-review { background: #60a5fa; }

    .link-row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
    }
    .link-row button {
      border: none;
      background: transparent;
      color: #2563eb;
      padding: 0;
      cursor: pointer;
    }

    /* Trainer overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.25);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .overlay.show {
      display: flex;
    }
    .trainer-sheet {
      width: 100%;
      max-width: 430px;
      height: 100vh;
      background: #f9fafb;
      border-radius: 0;
      box-shadow: 0 -10px 30px rgba(15,23,42,0.2);
      display: flex;
      flex-direction: column;
    }
    .trainer-header {
      padding: 10px 14px 6px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #e5e7eb;
      background: #ffffff;
    }
    .trainer-header button {
      border: none;
      background: #eff6ff;
      border-radius: 999px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #1d4ed8;
      cursor: pointer;
    }
    .trainer-header-title {
      display: flex;
      flex-direction: column;
    }
    .trainer-header-title span:first-child {
      font-size: 14px;
      font-weight: 600;
    }
    .trainer-header-title span:last-child {
      font-size: 12px;
      color: var(--text-muted);
    }
    .trainer-body {
      padding: 10px 14px 14px 14px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
    }
    .trainer-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 11px;
    }
    .trainer-card {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 12px 12px 10px 12px;
      border: 1px solid #e5e7eb;
      box-shadow: var(--shadow-soft);
    }
    .trainer-q-main {
      font-size: 16px;
      margin-bottom: 6px;
    }
    .trainer-q-main strong {
      font-size: 17px;
    }
    .trainer-q-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .pronoun-pill {
      display: inline-flex;
      padding: 3px 9px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 12px;
      margin-right: 6px;
    }
    .answer-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .answer-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 8px 11px;
      font-size: 14px;
      outline: none;
    }
    .answer-row input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #bfdbfe;
    }
    .answer-controls {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(to right, #2563eb, #1d4ed8);
      color: #f9fafb;
      box-shadow: 0 12px 22px rgba(37, 99, 235, 0.35);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-ghost {
      background: #eff6ff;
      color: #1d4ed8;
    }
    .btn:disabled {
      opacity: 0.6;
      box-shadow: none;
      cursor: default;
    }
    .feedback {
      margin-top: 8px;
      font-size: 13px;
      padding: 6px 9px;
      border-radius: 12px;
      background: #f3f4ff;
      color: #1f2937;
      border: 1px solid #e5e7eb;
    }
    .feedback.correct {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: #166534;
    }
    .feedback.incorrect {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
    }
    .tense-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }
    .mastery-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
      font-size: 11px;
    }
    .mastery-row button {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
    }
    .mastery-row button:first-child {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .trainer-footer {
      padding: 8px 14px 10px 14px;
      border-top: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 11px;
      color: var(--text-muted);
    }
    .trainer-footer strong {
      color: #111827;
    }

    /* Tense guide modal */
    .guide-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.32);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .guide-modal.show {
      display: flex;
    }
    .guide-sheet {
      width: 100%;
      max-width: 430px;
      height: 100vh;
      background: #ffffff;
      border-radius: 0;
      display: flex;
      flex-direction: column;
    }
    .guide-header {
      padding: 10px 14px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .guide-header button {
      border: none;
      background: #eff6ff;
      border-radius: 999px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #1d4ed8;
      cursor: pointer;
    }
    .guide-header h2 {
      margin: 0;
      font-size: 16px;
    }
    .guide-body {
      padding: 10px 14px 16px 14px;
      overflow-y: auto;
      flex: 1;
      font-size: 13px;
      color: #111827;
    }
    .guide-block {
      margin-bottom: 12px;
      padding: 10px 10px 8px 10px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .guide-block h3 {
      margin: 0 0 4px 0;
      font-size: 14px;
      color: #1d4ed8;
    }
    .guide-block p {
      margin: 3px 0;
    }
    .code {
      font-family: ui-monospace, Menlo, SFMono-Regular, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      background: #e5e7eb;
      border-radius: 6px;
      padding: 2px 5px;
    }
    .small-muted {
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (max-width: 430px) {
      .app {
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>French Verbs</h1>
    <small>Présent first · unlock more tenses later</small>
  </header>
  <main>
    <div class="section-title">Spaced repetition</div>
    <section class="card">
      <div class="card-header">
        <h2>Practice</h2>
        <span id="currentTenseLabel">Current tense: Présent</span>
      </div>

      <div class="mode-row" data-mode="learn">
        <div class="mode-main">
          <div class="mode-icon">＋</div>
          <div>
            <div class="mode-text-title">Learn new verbs</div>
            <div class="mode-text-sub" id="learnSub">Up to your daily quota of new verbs.</div>
          </div>
        </div>
        <div class="mode-chevron">›</div>
      </div>

      <div class="mode-row" data-mode="review">
        <div class="mode-main">
          <div class="mode-icon">⟳</div>
          <div>
            <div class="mode-text-title">Review verbs</div>
            <div class="mode-text-sub" id="reviewSub">Focused review of verbs you’ve already seen.</div>
          </div>
        </div>
        <div class="mode-chevron">›</div>
      </div>

      <div class="mode-row" data-mode="mixed">
        <div class="mode-main">
          <div class="mode-icon">✦</div>
          <div>
            <div class="mode-text-title">Mixed mode</div>
            <div class="mode-text-sub" id="mixedSub">Mix new verbs with review for variety.</div>
          </div>
        </div>
        <div class="mode-chevron">›</div>
      </div>
    </section>

    <div class="section-title">Stats</div>
    <section class="card">
      <div class="days-row" id="daysRow"></div>

      <div class="streak-row">
        <div class="streak-card">
          <div class="streak-label">Current streak</div>
          <div class="streak-value" id="currentStreak">0</div>
        </div>
        <div class="streak-card">
          <div class="streak-label">Best streak</div>
          <div class="streak-value" id="bestStreak">0</div>
        </div>
      </div>

      <div class="today-progress">
        <div class="circle" id="todayCircle">0</div>
        <div>
          <div class="today-text">Learned today: <span id="todayLearned">0</span>/<span id="dailyGoalText">20</span></div>
          <div class="today-sub" id="todaySubLabel">Tap a mode above to start today’s session.</div>
        </div>
      </div>

      <div class="chart-tabs">
        <button class="chart-tab active" data-range="7">7 days</button>
        <button class="chart-tab" data-range="30">30 days</button>
        <button class="chart-tab" data-range="90">90 days</button>
      </div>
      <div class="chart" id="chart"></div>
      <div class="legend-row">
        <div><span class="legend-color legend-new"></span>New verbs</div>
        <div><span class="legend-color legend-review"></span>Review questions</div>
      </div>

      <div class="link-row">
        <button id="openGuideBtn">Tense guide</button>
        <button id="openSettingsBtn">Daily goal & reset</button>
      </div>
    </section>
  </main>
</div>

<!-- Trainer overlay -->
<div class="overlay" id="trainerOverlay">
  <div class="trainer-sheet">
    <div class="trainer-header">
      <button id="trainerBackBtn">‹</button>
      <div class="trainer-header-title">
        <span id="trainerModeTitle">Learn new verbs</span>
        <span id="trainerModeSub">Présent · type the verb form only</span>
      </div>
    </div>
    <div class="trainer-body">
      <div class="trainer-meta">
        <span class="pill"><span class="pill-dot"></span> Today: <span id="trainerTodayCount">0</span> questions</span>
        <span class="pill">Accuracy: <span id="trainerAccuracy">0%</span></span>
        <span class="pill" id="trainerUnlockedLabel">Unlocked: Présent</span>
      </div>
      <div class="trainer-card">
        <div class="trainer-q-main" id="questionMain">Tap a mode to start.</div>
        <div class="trainer-q-sub" id="questionSub"></div>
        <div class="answer-row">
          <input type="text" id="answerInput" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="type the conjugated form (verb only)">
        </div>
        <div class="answer-controls">
          <button class="btn btn-primary" id="checkBtn">Check</button>
          <button class="btn btn-secondary" id="showBtn">Show</button>
          <button class="btn btn-ghost" id="nextBtn">Next</button>
        </div>
        <div id="feedback" class="feedback" style="display:none;"></div>
        <div class="tense-note" id="tenseNote"></div>
        <div class="mastery-row" id="masteryRow" style="display:none;">
          <button id="memorizeBtn">I've memorized this verb</button>
          <button id="keepBtn">Keep seeing this verb</button>
        </div>
      </div>
    </div>
    <div class="trainer-footer">
      <span id="unlockMessage"></span>
    </div>
  </div>
</div>

<!-- Tense guide modal -->
<div class="guide-modal" id="guideModal">
  <div class="guide-sheet">
    <div class="guide-header">
      <button id="guideCloseBtn">‹</button>
      <h2>Tense guide</h2>
    </div>
    <div class="guide-body">
      <div class="guide-block">
        <h3>Présent</h3>
        <p><strong>Use it for:</strong> habits, facts, feelings, things happening now, or very near future when the context is clear.</p>
        <p><strong>Regular -er pattern (parler):</strong></p>
        <p class="code">je parle, tu parles, il parle, nous parlons, vous parlez, ils parlent</p>
        <p><strong>Regular -ir pattern (finir):</strong></p>
        <p class="code">je finis, tu finis, il finit, nous finissons, vous finissez, ils finissent</p>
        <p><strong>Regular -re pattern (vendre):</strong></p>
        <p class="code">je vends, tu vends, il vend, nous vendons, vous vendez, ils vendent</p>
        <p><strong>Examples:</strong></p>
        <p>Je travaille à Vancouver. <span class="small-muted">(I work in Vancouver.)</span></p>
        <p>On se voit demain ? <span class="small-muted">(Are we seeing each other tomorrow?)</span></p>
      </div>

      <div class="guide-block">
        <h3>Passé composé</h3>
        <p><strong>Use it for:</strong> completed events in the past, “what happened”.</p>
        <p><strong>Structure:</strong> présent of <em>avoir</em> or <em>être</em> + past participle.</p>
        <p class="code">j'ai parlé, tu as parlé, il a parlé, nous avons parlé...</p>
        <p><strong>With être (movement / reflexive verbs):</strong></p>
        <p class="code">je suis allé(e), elle est arrivée, nous sommes partis</p>
        <p><strong>Examples:</strong></p>
        <p>J'ai fini le projet hier. <span class="small-muted">(I finished the project yesterday.)</span></p>
        <p>Elle est arrivée en retard. <span class="small-muted">(She arrived late.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Imparfait</h3>
        <p><strong>Use it for:</strong> background, descriptions, habits in the past, “was doing / used to”.</p>
        <p><strong>How to build it:</strong> take <em>nous</em> in the present, remove <em>-ons</em>, add:</p>
        <p class="code">-ais, -ais, -ait, -ions, -iez, -aient</p>
        <p><strong>Example (parler):</strong></p>
        <p class="code">nous parlons → je parlais, tu parlais, il parlait, nous parlions, vous parliez, ils parlaient</p>
        <p><strong>Examples:</strong></p>
        <p>Quand j'étais enfant, je jouais dehors tous les jours. <span class="small-muted">(When I was a child, I used to play outside every day.)</span></p>
        <p>Il faisait froid et il pleuvait. <span class="small-muted">(It was cold and it was raining.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Futur simple</h3>
        <p><strong>Use it for:</strong> future in general, promises, predictions.</p>
        <p><strong>Pattern (-er, -ir):</strong> infinitive + endings:</p>
        <p class="code">-ai, -as, -a, -ons, -ez, -ont</p>
        <p><strong>Example (parler):</strong></p>
        <p class="code">je parlerai, tu parleras, il parlera, nous parlerons, vous parlerez, ils parleront</p>
        <p><strong>Examples:</strong></p>
        <p>On se reverra bientôt. <span class="small-muted">(We will see each other again soon.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Conditionnel présent</h3>
        <p><strong>Use it for:</strong> politeness, wishes, hypotheses (“would”), advice.</p>
        <p><strong>Pattern:</strong> futur simple stem + imparfait endings.</p>
        <p class="code">je parlerais, tu parlerais, il parlerait, nous parlerions, vous parleriez, ils parleraient</p>
        <p><strong>Examples:</strong></p>
        <p>Je voudrais un café, s'il vous plaît. <span class="small-muted">(I’d like a coffee, please.)</span></p>
        <p>Si j'avais plus de temps, je ferais plus de sport. <span class="small-muted">(If I had more time, I would do more sport.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Subjonctif présent</h3>
        <p><strong>Use it for:</strong> after certain expressions of doubt, necessity, emotion, desire.</p>
        <p><strong>Common triggers:</strong> il faut que, je veux que, je suis content que, bien que, pour que, avant que…</p>
        <p><strong>Pattern (parler):</strong></p>
        <p class="code">que je parle, que tu parles, qu'il parle, que nous parlions, que vous parliez, qu'ils parlent</p>
        <p><strong>Examples:</strong></p>
        <p>Il faut que tu finisses ce travail. <span class="small-muted">(You have to finish this work.)</span></p>
        <p>Je suis content que tu sois ici. <span class="small-muted">(I’m happy that you’re here.)</span></p>
      </div>

      <p class="small-muted">
        In the trainer you always see the subject (je, tu, nous, etc.) and you type only the <strong>verb form</strong>.
        For composed forms, type the auxiliary + past participle (for example <span class="code">ai parlé</span>).
        For the subjonctif, we practise the conjugated form without writing <em>que</em>.
      </p>
    </div>
  </div>
</div>

<script>
const INITIAL_VERBS = [
  { inf: 'être', en: 'to be', group: 'irreg' },
  { inf: 'avoir', en: 'to have', group: 'irreg' },
  { inf: 'aller', en: 'to go', group: 'irreg' },
  { inf: 'faire', en: 'to do / to make', group: 'irreg' },
  { inf: 'dire', en: 'to say / to tell', group: 'irreg' },
  { inf: 'pouvoir', en: 'to be able to / can', group: 'irreg' },
  { inf: 'vouloir', en: 'to want', group: 'irreg' },
  { inf: 'devoir', en: 'to have to / must', group: 'irreg' },
  { inf: 'savoir', en: 'to know (a fact)', group: 'irreg' },
  { inf: 'connaître', en: 'to know (someone / place)', group: 'irreg' },
  { inf: 'venir', en: 'to come', group: 'irreg' },
  { inf: 'revenir', en: 'to come back', group: 'irreg' },
  { inf: 'devenir', en: 'to become', group: 'irreg' },
  { inf: 'prendre', en: 'to take', group: 'irreg' },
  { inf: 'apprendre', en: 'to learn', group: 'irreg' },
  { inf: 'comprendre', en: 'to understand', group: 'irreg' },
  { inf: 'mettre', en: 'to put / to place', group: 'irreg' },
  { inf: 'permettre', en: 'to allow', group: 'irreg' },
  { inf: 'promettre', en: 'to promise', group: 'irreg' },
  { inf: 'voir', en: 'to see', group: 'irreg' },
  { inf: 'revoir', en: 'to see again', group: 'irreg' },
  { inf: 'croire', en: 'to believe', group: 'irreg' },
  { inf: 'suivre', en: 'to follow', group: 'irreg' },
  { inf: 'vivre', en: 'to live', group: 'irreg' },
  { inf: 'sortir', en: 'to go out', group: 'irreg' },
  { inf: 'partir', en: 'to leave', group: 'irreg' },
  { inf: 'dormir', en: 'to sleep', group: 'irreg' },
  { inf: 'servir', en: 'to serve', group: 'irreg' },
  { inf: 'sentir', en: 'to feel / to smell', group: 'irreg' },
  { inf: 'écrire', en: 'to write', group: 'irreg' },
  { inf: 'décrire', en: 'to describe', group: 'irreg' },
  { inf: 'lire', en: 'to read', group: 'irreg' },
  { inf: 'boire', en: 'to drink', group: 'irreg' },
  { inf: 'ouvrir', en: 'to open', group: 'irreg' },
  { inf: 'offrir', en: 'to offer', group: 'irreg' },
  { inf: 'souffrir', en: 'to suffer', group: 'irreg' },
  { inf: 'recevoir', en: 'to receive', group: 'irreg' },
  { inf: 'apercevoir', en: 'to notice', group: 'irreg' },
  { inf: 's'asseoir', en: 'to sit down', group: 'irreg' },
  { inf: 'rire', en: 'to laugh', group: 'irreg' },
  { inf: 'sourire', en: 'to smile', group: 'irreg' },
  { inf: 'conduire', en: 'to drive', group: 'irreg' },
  { inf: 'construire', en: 'to build', group: 'irreg' },
  { inf: 'produire', en: 'to produce', group: 'irreg' },
  { inf: 'traduire', en: 'to translate', group: 'irreg' },
  { inf: 'mettre', en: 'to put / to place', group: 'irreg' },
  { inf: 'remettre', en: 'to put back', group: 'irreg' },
  { inf: 'tenir', en: 'to hold', group: 'irreg' },
  { inf: 'obtenir', en: 'to obtain', group: 'irreg' },
  { inf: 'naître', en: 'to be born', group: 'irreg' },
  { inf: 'mourir', en: 'to die', group: 'irreg' },
  { inf: 'falloir', en: 'to be necessary', group: 'irreg' },
  { inf: 'pleuvoir', en: 'to rain', group: 'irreg' },
  { inf: 'soutenir', en: 'to support', group: 'irreg' },
  { inf: 'prévoir', en: 'to plan / to foresee', group: 'irreg' },
  { inf: 'prévenir', en: 'to warn', group: 'irreg' },
  { inf: 'parler', en: 'to speak', group: 'er' },
  { inf: 'aimer', en: 'to like / to love', group: 'er' },
  { inf: 'regarder', en: 'to watch / to look at', group: 'er' },
  { inf: 'écouter', en: 'to listen', group: 'er' },
  { inf: 'travailler', en: 'to work', group: 'er' },
  { inf: 'étudier', en: 'to study', group: 'er' },
  { inf: 'habiter', en: 'to live (somewhere)', group: 'er' },
  { inf: 'penser', en: 'to think', group: 'er' },
  { inf: 'trouver', en: 'to find', group: 'er' },
  { inf: 'donner', en: 'to give', group: 'er' },
  { inf: 'demander', en: 'to ask', group: 'er' },
  { inf: 'jouer', en: 'to play', group: 'er' },
  { inf: 'manger', en: 'to eat', group: 'er' },
  { inf: 'payer', en: 'to pay', group: 'er' },
  { inf: 'acheter', en: 'to buy', group: 'er' },
  { inf: 'porter', en: 'to wear / to carry', group: 'er' },
  { inf: 'arriver', en: 'to arrive / to happen', group: 'er' },
  { inf: 'entrer', en: 'to enter', group: 'er' },
  { inf: 'tomber', en: 'to fall', group: 'er' },
  { inf: 'rester', en: 'to stay', group: 'er' },
  { inf: 'retourner', en: 'to return', group: 'er' },
  { inf: 'rentrer', en: 'to go back (home)', group: 'er' },
  { inf: 'montrer', en: 'to show', group: 'er' },
  { inf: 'fermer', en: 'to close', group: 'er' },
  { inf: 'ouvrir', en: 'to open', group: 'irreg' },
  { inf: 'accepter', en: 'to accept', group: 'er' },
  { inf: 'refuser', en: 'to refuse', group: 'er' },
  { inf: 'continuer', en: 'to continue', group: 'er' },
  { inf: 'arrêter', en: 'to stop', group: 'er' },
  { inf: 'utiliser', en: 'to use', group: 'er' },
  { inf: 'changer', en: 'to change', group: 'er' },
  { inf: 'garder', en: 'to keep', group: 'er' },
  { inf: 'oublier', en: 'to forget', group: 'er' },
  { inf: 'chercher', en: 'to look for', group: 'er' },
  { inf: 'travailler', en: 'to work', group: 'er' },
  { inf: 'aider', en: 'to help', group: 'er' },
  { inf: 'marcher', en: 'to walk', group: 'er' },
  { inf: 'rêver', en: 'to dream', group: 'er' },
  { inf: 'chanter', en: 'to sing', group: 'er' },
  { inf: 'danser', en: 'to dance', group: 'er' },
  { inf: 'nager', en: 'to swim', group: 'er' },
  { inf: 'visiter', en: 'to visit (a place)', group: 'er' },
  { inf: 'préparer', en: 'to prepare', group: 'er' },
  { inf: 'cuisiner', en: 'to cook', group: 'er' },
  { inf: 'laver', en: 'to wash', group: 'er' },
  { inf: 'nettoyer', en: 'to clean', group: 'er' },
  { inf: 'adorer', en: 'to adore', group: 'er' },
  { inf: 'détester', en: 'to hate', group: 'er' },
  { inf: 'espérer', en: 'to hope', group: 'er' },
  { inf: 'rencontrer', en: 'to meet', group: 'er' },
  { inf: 'accompagner', en: 'to go with / to accompany', group: 'er' },
  { inf: 'organiser', en: 'to organize', group: 'er' },
  { inf: 'participer', en: 'to take part', group: 'er' },
  { inf: 'inviter', en: 'to invite', group: 'er' },
  { inf: 'raconter', en: 'to tell (a story)', group: 'er' },
  { inf: 'expliquer', en: 'to explain', group: 'er' },
  { inf: 'monter', en: 'to go up / climb', group: 'er' },
  { inf: 'descendre', en: 'to go down', group: 're' },
  { inf: 'passer', en: 'to pass / spend (time)', group: 'er' },
  { inf: 'penser', en: 'to think', group: 'er' },
  { inf: 'noter', en: 'to note / write down', group: 'er' },
  { inf: 'appeler', en: 'to call (on the phone)', group: 'er' },
  { inf: 'rappeler', en: 'to call back / remind', group: 'er' },
  { inf: 'essayer', en: 'to try', group: 'er' },
  { inf: 's'arrêter', en: 'to stop (oneself)', group: 'er' },
  { inf: 'se lever', en: 'to get up', group: 'er' },
  { inf: 'se coucher', en: 'to go to bed', group: 'er' },
  { inf: 'se laver', en: 'to wash oneself', group: 'er' },
  { inf: 'se préparer', en: 'to get ready', group: 'er' },
  { inf: 'se promener', en: 'to go for a walk', group: 'er' },
  { inf: 's'amuser', en: 'to have fun', group: 'er' },
  { inf: 'se rappeler', en: 'to remember', group: 'er' },
  { inf: 'travailler', en: 'to work', group: 'er' },
  { inf: 'réparer', en: 'to repair', group: 'er' },
  { inf: 'installer', en: 'to install / set up', group: 'er' },
  { inf: 'brancher', en: 'to plug in', group: 'er' },
  { inf: 'débrancher', en: 'to unplug', group: 'er' },
  { inf: 'tester', en: 'to test', group: 'er' },
  { inf: 'corriger', en: 'to correct', group: 'er' },
  { inf: 'améliorer', en: 'to improve', group: 'er' },
  { inf: 'proposer', en: 'to suggest', group: 'er' },
  { inf: 'conseiller', en: 'to advise', group: 'er' },
  { inf: 'informer', en: 'to inform', group: 'er' },
  { inf: 'prévenir', en: 'to warn', group: 'irreg' },
  { inf: 'signer', en: 'to sign', group: 'er' },
  { inf: 'téléphoner', en: 'to phone', group: 'er' },
  { inf: 'envoyer', en: 'to send', group: 'er' },
  { inf: 'cliquer', en: 'to click', group: 'er' },
  { inf: 'télécharger', en: 'to download', group: 'er' },
  { inf: 'imprimer', en: 'to print', group: 'er' },
  { inf: 'sauvegarder', en: 'to save (a file)', group: 'er' },
  { inf: 'garder', en: 'to keep', group: 'er' },
  { inf: 'sauver', en: 'to save (a person)', group: 'er' },
  { inf: 'protéger', en: 'to protect', group: 'er' },
  { inf: 'planifier', en: 'to plan', group: 'er' },
  { inf: 'diriger', en: 'to lead / manage', group: 'er' },
  { inf: 'gérer', en: 'to manage', group: 'er' },
  { inf: 'organiser', en: 'to organize', group: 'er' },
  { inf: 'visiter', en: 'to visit', group: 'er' },
  { inf: 'supporter', en: 'to support / tolerate', group: 'er' },
  { inf: 'respecter', en: 'to respect', group: 'er' },
  { inf: 'toucher', en: 'to touch', group: 'er' },
  { inf: 'éviter', en: 'to avoid', group: 'er' },
  { inf: 'bouger', en: 'to move', group: 'er' },
  { inf: 'tirer', en: 'to pull / shoot', group: 'er' },
  { inf: 'pousser', en: 'to push', group: 'er' },
  { inf: 'casser', en: 'to break', group: 'er' },
  { inf: 'tourner', en: 'to turn / to film', group: 'er' },
  { inf: 'plier', en: 'to fold', group: 'er' },
  { inf: 'poser', en: 'to put down / pose', group: 'er' },
  { inf: 'compter', en: 'to count', group: 'er' },
  { inf: 'examiner', en: 'to examine', group: 'er' },
  { inf: 'joindre', en: 'to attach / join', group: 'irreg' },
  { inf: 'attirer', en: 'to attract', group: 'er' },
  { inf: 'limiter', en: 'to limit', group: 'er' },
  { inf: 'mesurer', en: 'to measure', group: 'er' },
  { inf: 'publier', en: 'to publish', group: 'er' },
  { inf: 'terminer', en: 'to finish / end', group: 'er' },
  { inf: 'apprécier', en: 'to appreciate', group: 'er' },
  { inf: 'bavarder', en: 'to chat', group: 'er' },
  { inf: 'choisir', en: 'to choose', group: 'ir' },
  { inf: 'finir', en: 'to finish', group: 'ir' },
  { inf: 'réussir', en: 'to succeed', group: 'ir' },
  { inf: 'grandir', en: 'to grow', group: 'ir' },
  { inf: 'maigrir', en: 'to lose weight', group: 'ir' },
  { inf: 'grossir', en: 'to gain weight', group: 'ir' },
  { inf: 'réfléchir', en: 'to think / reflect', group: 'ir' },
  { inf: 'obéir', en: 'to obey', group: 'ir' },
  { inf: 'punir', en: 'to punish', group: 'ir' },
  { inf: 'remplir', en: 'to fill', group: 'ir' },
  { inf: 'agir', en: 'to act', group: 'ir' },
  { inf: 'vendre', en: 'to sell', group: 're' },
  { inf: 'attendre', en: 'to wait', group: 're' },
  { inf: 'répondre', en: 'to answer', group: 're' },
  { inf: 'entendre', en: 'to hear', group: 're' },
  { inf: 'perdre', en: 'to lose', group: 're' },
  { inf: 'rendre', en: 'to give back', group: 're' },
  { inf: 'confondre', en: 'to confuse', group: 're' },
  { inf: 'fondre', en: 'to melt', group: 're' },
];

const STORAGE_KEY = 'frenchVerbApp_overhaul_v2';

const PRONOUNS = ["je","tu","il/elle","nous","vous","ils/elles"];
const DAY_LABELS = ["S","M","T","W","T","F","S"];

const IRREGULAR_PRESENT = {
  "être": { "je":"suis","tu":"es","il/elle":"est","nous":"sommes","vous":"êtes","ils/elles":"sont" },
  "avoir": { "je":"ai","tu":"as","il/elle":"a","nous":"avons","vous":"avez","ils/elles":"ont" },
  "aller": { "je":"vais","tu":"vas","il/elle":"va","nous":"allons","vous":"allez","ils/elles":"vont" },
  "faire": { "je":"fais","tu":"fais","il/elle":"fait","nous":"faisons","vous":"faites","ils/elles":"font" },
  "dire": { "je":"dis","tu":"dis","il/elle":"dit","nous":"disons","vous":"dites","ils/elles":"disent" },
  "pouvoir": { "je":"peux","tu":"peux","il/elle":"peut","nous":"pouvons","vous":"pouvez","ils/elles":"peuvent" },
  "vouloir": { "je":"veux","tu":"veux","il/elle":"veut","nous":"voulons","vous":"voulez","ils/elles":"veulent" },
  "devoir": { "je":"dois","tu":"dois","il/elle":"doit","nous":"devons","vous":"devez","ils/elles":"doivent" },
  "savoir": { "je":"sais","tu":"sais","il/elle":"sait","nous":"savons","vous":"savez","ils/elles":"savent" },
  "connaître": { "je":"connais","tu":"connais","il/elle":"connaît","nous":"connaissons","vous":"connaissez","ils/elles":"connaissent" },
  "venir": { "je":"viens","tu":"viens","il/elle":"vient","nous":"venons","vous":"venez","ils/elles":"viennent" },
  "revenir": { "je":"reviens","tu":"reviens","il/elle":"revient","nous":"revenons","vous":"revenez","ils/elles":"reviennent" },
  "devenir": { "je":"deviens","tu":"deviens","il/elle":"devient","nous":"devenons","vous":"devenez","ils/elles":"deviennent" },
  "prendre": { "je":"prends","tu":"prends","il/elle":"prend","nous":"prenons","vous":"prenez","ils/elles":"prennent" },
  "apprendre": { "je":"apprends","tu":"apprends","il/elle":"apprend","nous":"apprenons","vous":"apprenez","ils/elles":"apprennent" },
  "comprendre": { "je":"comprends","tu":"comprends","il/elle":"comprend","nous":"comprenons","vous":"comprenez","ils/elles":"comprennent" },
  "mettre": { "je":"mets","tu":"mets","il/elle":"met","nous":"mettons","vous":"mettez","ils/elles":"mettent" },
  "permettre": { "je":"permets","tu":"permets","il/elle":"permet","nous":"permettons","vous":"permettez","ils/elles":"permettent" },
  "promettre": { "je":"promets","tu":"promets","il/elle":"promet","nous":"promettons","vous":"promettez","ils/elles":"promettent" },
  "voir": { "je":"vois","tu":"vois","il/elle":"voit","nous":"voyons","vous":"voyez","ils/elles":"voient" },
  "revoir": { "je":"revois","tu":"revois","il/elle":"revoit","nous":"revoyons","vous":"revoyez","ils/elles":"revoient" },
  "croire": { "je":"crois","tu":"crois","il/elle":"croit","nous":"croyons","vous":"croyez","ils/elles":"croient" },
  "suivre": { "je":"suis","tu":"suis","il/elle":"suit","nous":"suivons","vous":"suivez","ils/elles":"suivent" },
  "vivre": { "je":"vis","tu":"vis","il/elle":"vit","nous":"vivons","vous":"vivez","ils/elles":"vivent" },
  "sortir": { "je":"sors","tu":"sors","il/elle":"sort","nous":"sortons","vous":"sortez","ils/elles":"sortent" },
  "partir": { "je":"pars","tu":"pars","il/elle":"part","nous":"partons","vous":"partez","ils/elles":"partent" },
  "dormir": { "je":"dors","tu":"dors","il/elle":"dort","nous":"dormons","vous":"dormez","ils/elles":"dorment" },
  "servir": { "je":"sers","tu":"sers","il/elle":"sert","nous":"servons","vous":"servez","ils/elles":"servent" },
  "sentir": { "je":"sens","tu":"sens","il/elle":"sent","nous":"sentons","vous":"sentez","ils/elles":"sentent" },
  "écrire": { "je":"écris","tu":"écris","il/elle":"écrit","nous":"écrivons","vous":"écrivez","ils/elles":"écrivent" },
  "décrire": { "je":"décris","tu":"décris","il/elle":"décrit","nous":"décrivons","vous":"décrivez","ils/elles":"décrivent" },
  "lire": { "je":"lis","tu":"lis","il/elle":"lit","nous":"lisons","vous":"lisez","ils/elles":"lisent" },
  "boire": { "je":"bois","tu":"bois","il/elle":"boit","nous":"buvons","vous":"buvez","ils/elles":"boivent" },
  "ouvrir": { "je":"ouvre","tu":"ouvres","il/elle":"ouvre","nous":"ouvrons","vous":"ouvrez","ils/elles":"ouvrent" },
  "offrir": { "je":"offre","tu":"offres","il/elle":"offre","nous":"offrons","vous":"offrez","ils/elles":"offrent" },
  "souffrir": { "je":"souffre","tu":"souffres","il/elle":"souffre","nous":"souffrons","vous":"souffrez","ils/elles":"souffrent" },
  "recevoir": { "je":"reçois","tu":"reçois","il/elle":"reçoit","nous":"recevons","vous":"recevez","ils/elles":"reçoivent" },
  "apercevoir": { "je":"aperçois","tu":"aperçois","il/elle":"aperçoit","nous":"apercevons","vous":"apercevez","ils/elles":"aperçoivent" },
  "s'asseoir": { "je":"m'assieds","tu":"t'assieds","il/elle":"s'assied","nous":"nous asseyons","vous":"vous asseyez","ils/elles":"s'asseyent" },
  "rire": { "je":"ris","tu":"ris","il/elle":"rit","nous":"rions","vous":"riez","ils/elles":"rient" },
  "sourire": { "je":"souris","tu":"souris","il/elle":"sourit","nous":"sourions","vous":"souriez","ils/elles":"sourient" },
  "conduire": { "je":"conduis","tu":"conduis","il/elle":"conduit","nous":"conduisons","vous":"conduisez","ils/elles":"conduisent" },
  "construire": { "je":"construis","tu":"construis","il/elle":"construit","nous":"construisons","vous":"construisez","ils/elles":"construisent" },
  "produire": { "je":"produis","tu":"produis","il/elle":"produit","nous":"produisons","vous":"produisez","ils/elles":"produisent" },
  "traduire": { "je":"traduis","tu":"traduis","il/elle":"traduit","nous":"traduisons","vous":"traduisez","ils/elles":"traduisent" },
  "tenir": { "je":"tiens","tu":"tiens","il/elle":"tient","nous":"tenons","vous":"tenez","ils/elles":"tiennent" },
  "obtenir": { "je":"obtiens","tu":"obtiens","il/elle":"obtient","nous":"obtenons","vous":"obtenez","ils/elles":"obtiennent" },
  "naître": { "je":"nais","tu":"nais","il/elle":"naît","nous":"naissons","vous":"naissez","ils/elles":"naissent" },
  "mourir": { "je":"meurs","tu":"meurs","il/elle":"meurt","nous":"mourons","vous":"mourez","ils/elles":"meurent" },
  "falloir": { "il/elle":"faut" },
  "pleuvoir": { "il/elle":"pleut" },
  "soutenir": { "je":"soutiens","tu":"soutiens","il/elle":"soutient","nous":"soutenons","vous":"soutenez","ils/elles":"soutiennent" },
  "prévoir": { "je":"prévois","tu":"prévois","il/elle":"prévoit","nous":"prévoyons","vous":"prévoyez","ils/elles":"prévoient" },
  "prévenir": { "je":"préviens","tu":"préviens","il/elle":"prévient","nous":"prévenons","vous":"prévenez","ils/elles":"préviennent" }
};

function todayStr() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    return {
      verbs: INITIAL_VERBS,
      progress: {
        perVerb: {},
        historyByDate: {},
        streak: { current: 0, best: 0, lastDate: null }
      },
      settings: { dailyTarget: 20 }
    };
  }
  try {
    const parsed = JSON.parse(raw);
    if (!parsed.verbs) parsed.verbs = INITIAL_VERBS;
    if (!parsed.progress) parsed.progress = { perVerb:{}, historyByDate:{}, streak:{current:0,best:0,lastDate:null} };
    if (!parsed.progress.perVerb) parsed.progress.perVerb = {};
    if (!parsed.progress.historyByDate) parsed.progress.historyByDate = {};
    if (!parsed.progress.streak) parsed.progress.streak = { current:0,best:0,lastDate:null };
    if (!parsed.settings) parsed.settings = { dailyTarget: 20 };
    return parsed;
  } catch (e) {
    console.warn("Failed to parse saved state, resetting.", e);
    return {
      verbs: INITIAL_VERBS,
      progress: {
        perVerb: {},
        historyByDate: {},
        streak: { current: 0, best: 0, lastDate: null }
      },
      settings: { dailyTarget: 20 }
    };
  }
}

let state = loadState();
const TODAY = todayStr();
let currentChartRange = 7;

function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.error("Failed to save state:", e);
  }
}

function getHistory(dateStr) {
  if (!state.progress.historyByDate[dateStr]) {
    state.progress.historyByDate[dateStr] = {
      newCount: 0,
      reviewCount: 0,
      correct: 0,
      wrong: 0
    };
  }
  return state.progress.historyByDate[dateStr];
}

function getVerbStats(inf) {
  if (!state.progress.perVerb[inf]) {
    state.progress.perVerb[inf] = {
      timesSeen: 0,
      correct: 0,
      wrong: 0,
      firstSeen: null,
      lastSeen: null,
      mastered: false,
      needExtra: false
    };
  }
  return state.progress.perVerb[inf];
}

function updateStreak() {
  const streak = state.progress.streak;
  const last = streak.lastDate;
  const today = TODAY;
  if (last === today) return;
  if (!last) {
    streak.current = 1;
  } else {
    const lastDateObj = new Date(last);
    const todayDateObj = new Date(today);
    const diff = (todayDateObj - lastDateObj) / (1000*60*60*24);
    if (diff <= 1.5 && diff >= 0.5) {
      streak.current += 1;
    } else {
      streak.current = 1;
    }
  }
  if (streak.current > streak.best) streak.best = streak.current;
  streak.lastDate = today;
}

function conjugatePresent(verb, pronoun) {
  const inf = verb.inf;
  // ignore reflexive for now in auto rules
  if (inf.startsWith("se ") || inf.startsWith("s'") || inf.startsWith("s’") || inf.startsWith("s ")) {
    return null;
  }
  if (IRREGULAR_PRESENT[inf]) {
    const m = IRREGULAR_PRESENT[inf];
    if (m[pronoun]) return m[pronoun];
    if (pronoun === "il/elle" && m["il"]) return m["il"];
    return null;
  }
  const group = verb.group;
  if (group === "er") {
    const stem = inf.slice(0, -2);
    if (pronoun === "je") return stem + "e";
    if (pronoun === "tu") return stem + "es";
    if (pronoun === "il/elle") return stem + "e";
    if (pronoun === "nous") return stem + "ons";
    if (pronoun === "vous") return stem + "ez";
    if (pronoun === "ils/elles") return stem + "ent";
  } else if (group === "ir") {
    const stem = inf.slice(0, -2);
    if (pronoun === "je") return stem + "is";
    if (pronoun === "tu") return stem + "is";
    if (pronoun === "il/elle") return stem + "it";
    if (pronoun === "nous") return stem + "issons";
    if (pronoun === "vous") return stem + "issez";
    if (pronoun === "ils/elles") return stem + "issent";
  } else if (group === "re") {
    const stem = inf.slice(0, -2);
    if (pronoun === "je") return stem + "s";
    if (pronoun === "tu") return stem + "s";
    if (pronoun === "il/elle") return stem;
    if (pronoun === "nous") return stem + "ons";
    if (pronoun === "vous") return stem + "ez";
    if (pronoun === "ils/elles") return stem + "ent";
  }
  return null;
}

function getConjugation(verb, pronoun) {
  return conjugatePresent(verb, pronoun);
}

function randomChoice(arr) {
  if (!arr.length) return null;
  const idx = Math.floor(Math.random() * arr.length);
  return arr[idx];
}

function buildQuestion(mode) {
  const verbs = state.verbs;
  const stats = state.progress.perVerb;
  const todayHist = getHistory(TODAY);
  const allowNew = todayHist.newCount < state.settings.dailyTarget;

  const candidates = verbs.filter(v => {
    const s = stats[v.inf];
    return !s || !s.mastered;
  });

  const unseen = [];
  const seen = [];
  const extra = [];

  for (const v of candidates) {
    const s = stats[v.inf];
    // require that we can conjugate this verb
    if (!getConjugation(v, "je")) continue;
    if (s && s.needExtra) extra.push(v);
    if (s && s.timesSeen > 0) seen.push(v);
    else unseen.push(v);
  }

  let pool = null;

  if (extra.length) {
    pool = extra;
  } else {
    if (mode === "learn") {
      if (allowNew && unseen.length) pool = unseen;
      else if (seen.length) pool = seen;
      else pool = unseen;
    } else if (mode === "review") {
      if (seen.length) pool = seen;
      else if (allowNew && unseen.length) pool = unseen;
      else pool = seen;
    } else {
      // mixed
      if (Math.random() < 0.5 && allowNew && unseen.length) pool = unseen;
      else if (seen.length) pool = seen;
      else if (allowNew && unseen.length) pool = unseen;
      else pool = seen;
    }
  }

  if (!pool || !pool.length) return null;

  const verb = randomChoice(pool);
  const pronoun = randomChoice(PRONOUNS);
  const answer = getConjugation(verb, pronoun);
  if (!answer) return buildQuestion(mode);
  return {
    verbInf: verb.inf,
    verbEn: verb.en,
    pronoun,
    answer
  };
}

function normalise(str) {
  return (str || "").trim().toLowerCase();
}

// DOM refs
const daysRow = document.getElementById("daysRow");
const currentStreakEl = document.getElementById("currentStreak");
const bestStreakEl = document.getElementById("bestStreak");
const todayCircle = document.getElementById("todayCircle");
const todayLearnedEl = document.getElementById("todayLearned");
const dailyGoalText = document.getElementById("dailyGoalText");
const todaySubLabel = document.getElementById("todaySubLabel");
const chartEl = document.getElementById("chart");
const chartTabs = document.querySelectorAll(".chart-tab");
const currentTenseLabel = document.getElementById("currentTenseLabel");

const trainerOverlay = document.getElementById("trainerOverlay");
const trainerBackBtn = document.getElementById("trainerBackBtn");
const trainerModeTitle = document.getElementById("trainerModeTitle");
const trainerModeSub = document.getElementById("trainerModeSub");
const trainerTodayCount = document.getElementById("trainerTodayCount");
const trainerAccuracy = document.getElementById("trainerAccuracy");
const trainerUnlockedLabel = document.getElementById("trainerUnlockedLabel");
const trainerFooter = document.getElementById("unlockMessage");

const questionMain = document.getElementById("questionMain");
const questionSub = document.getElementById("questionSub");
const answerInput = document.getElementById("answerInput");
const checkBtn = document.getElementById("checkBtn");
const showBtn = document.getElementById("showBtn");
const nextBtn = document.getElementById("nextBtn");
const feedbackEl = document.getElementById("feedback");
const tenseNote = document.getElementById("tenseNote");
const masteryRow = document.getElementById("masteryRow");
const memorizeBtn = document.getElementById("memorizeBtn");
const keepBtn = document.getElementById("keepBtn");

const openGuideBtn = document.getElementById("openGuideBtn");
const openSettingsBtn = document.getElementById("openSettingsBtn");
const guideModal = document.getElementById("guideModal");
const guideCloseBtn = document.getElementById("guideCloseBtn");
const learnRow = document.querySelector('.mode-row[data-mode="learn"]');
const reviewRow = document.querySelector('.mode-row[data-mode="review"]');
const mixedRow = document.querySelector('.mode-row[data-mode="mixed"]');

let currentMode = null;
let currentQuestion = null;

function renderDaysRow() {
  const todayIndex = new Date().getDay(); // 0 Sunday
  daysRow.innerHTML = "";
  for (let i = 0; i < 7; i++) {
    const d = document.createElement("div");
    d.className = "day-dot" + (i === todayIndex ? " active" : "");
    d.textContent = DAY_LABELS[i];
    daysRow.appendChild(d);
  }
}

function renderStats() {
  const histToday = getHistory(TODAY);
  todayLearnedEl.textContent = histToday.newCount;
  dailyGoalText.textContent = state.settings.dailyTarget;
  const pct = Math.min(100, (histToday.newCount / state.settings.dailyTarget) * 100);
  todayCircle.textContent = histToday.newCount;
  todayCircle.style.borderTopColor = pct >= 100 ? "#16a34a" : "#2563eb";

  currentStreakEl.textContent = state.progress.streak.current;
  bestStreakEl.textContent = state.progress.streak.best;

  if (histToday.newCount >= state.settings.dailyTarget) {
    todaySubLabel.textContent = "Daily new-verb goal reached. You can still review verbs.";
  } else {
    todaySubLabel.textContent = "Tap a mode above to start today’s session.";
  }

  currentTenseLabel.textContent = "Current tense: Présent (more tenses later)";
}

function renderChart(rangeDays) {
  const bars = [];
  const todayDate = new Date(TODAY);
  for (let i = rangeDays - 1; i >= 0; i--) {
    const d = new Date(todayDate);
    d.setDate(d.getDate() - i);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const key = `${y}-${m}-${day}`;
    const h = state.progress.historyByDate[key] || { newCount:0, reviewCount:0 };
    bars.push({ date:key.slice(5), new:h.newCount || 0, review:h.reviewCount || 0 });
  }
  const max = Math.max(1, ...bars.map(b => b.new + b.review));
  chartEl.innerHTML = "";
  bars.forEach(b => {
    const col = document.createElement("div");
    col.className = "bar-col";

    const stack = document.createElement("div");
    stack.className = "bar-stack";
    const segNew = document.createElement("div");
    segNew.className = "bar-seg bar-new";
    segNew.style.height = (b.new / max * 100) + "%";
    const segReview = document.createElement("div");
    segReview.className = "bar-seg bar-review";
    segReview.style.height = (b.review / max * 100) + "%";

    stack.appendChild(segNew);
    stack.appendChild(segReview);
    col.appendChild(stack);

    const label = document.createElement("div");
    label.className = "bar-label";
    label.textContent = b.date.slice(3);
    col.appendChild(label);

    chartEl.appendChild(col);
  });
}

chartTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    chartTabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    currentChartRange = parseInt(tab.dataset.range, 10);
    renderChart(currentChartRange);
  });
});

function updateTrainerMeta() {
  const hist = getHistory(TODAY);
  const totalQuestions = hist.newCount + hist.reviewCount;
  trainerTodayCount.textContent = totalQuestions;
  const total = hist.correct + hist.wrong;
  const acc = total ? Math.round(hist.correct * 100 / total) : 0;
  trainerAccuracy.textContent = acc + "%";
  trainerUnlockedLabel.textContent = "Unlocked: Présent";
}

function setTenseNote() {
  tenseNote.textContent = "Présent: think about what is true now, generally, or in the near future. Type only the verb form, without the pronoun.";
}

function startTrainer(mode) {
  currentMode = mode;
  trainerOverlay.classList.add("show");
  trainerFooter.textContent = "";
  masteryRow.style.display = "none";
  if (mode === "learn") {
    trainerModeTitle.textContent = "Learn new verbs";
    trainerModeSub.textContent = "Présent · new verbs first, then review";
  } else if (mode === "review") {
    trainerModeTitle.textContent = "Review verbs";
    trainerModeSub.textContent = "Présent · mostly verbs you’ve already seen";
  } else {
    trainerModeTitle.textContent = "Mixed mode";
    trainerModeSub.textContent = "Présent · mix of new and review";
  }
  updateTrainerMeta();
  nextQuestion();
  document.body.style.overflow = "hidden";
}

function closeTrainer() {
  trainerOverlay.classList.remove("show");
  currentMode = null;
  currentQuestion = null;
  feedbackEl.style.display = "none";
  masteryRow.style.display = "none";
  document.body.style.overflow = "";
}

trainerBackBtn.addEventListener("click", closeTrainer);

function nextQuestion() {
  if (!currentMode) return;
  const q = buildQuestion(currentMode);
  if (!q) {
    questionMain.textContent = "No more verbs available right now.";
    questionSub.textContent = "You may have mastered or exhausted today’s pool.";
    feedbackEl.style.display = "none";
    masteryRow.style.display = "none";
    return;
  }
  currentQuestion = q;
  questionMain.innerHTML = `<span class="pronoun-pill">${q.pronoun}</span> <strong>${q.verbInf}</strong>`;
  questionSub.textContent = (q.verbEn ? q.verbEn + " · " : "") + "Présent – type only the verb form.";
  answerInput.value = "";
  answerInput.focus();
  feedbackEl.style.display = "none";
  masteryRow.style.display = "none";
  setTenseNote();
}

function checkAnswer(showOnly) {
  if (!currentQuestion) return;
  const hist = getHistory(TODAY);
  const verbStats = getVerbStats(currentQuestion.verbInf);

  if (showOnly) {
    feedbackEl.style.display = "block";
    feedbackEl.className = "feedback";
    feedbackEl.textContent = `Correct form: ${currentQuestion.pronoun} ${currentQuestion.answer}`;
    masteryRow.style.display = "flex";
    return;
  }

  const user = answerInput.value;
  const ok = normalise(user) === normalise(currentQuestion.answer);

  verbStats.timesSeen += 1;
  verbStats.lastSeen = TODAY;

  if (!verbStats.firstSeen) {
    // first time ever
    if (hist.newCount < state.settings.dailyTarget) {
      verbStats.firstSeen = TODAY;
      hist.newCount += 1;
    } else {
      verbStats.firstSeen = TODAY;
      hist.reviewCount += 1;
    }
  } else {
    hist.reviewCount += 1;
  }

  if (ok) {
    verbStats.correct += 1;
    hist.correct += 1;
    feedbackEl.style.display = "block";
    feedbackEl.className = "feedback correct";
    feedbackEl.textContent = `Nice ✔  ${currentQuestion.pronoun} ${currentQuestion.answer}`;
  } else {
    verbStats.wrong += 1;
    hist.wrong += 1;
    feedbackEl.style.display = "block";
    feedbackEl.className = "feedback incorrect";
    feedbackEl.textContent = `Not quite ✘  You typed "${user || "—"}". Correct: ${currentQuestion.pronoun} ${currentQuestion.answer}`;
  }

  updateStreak();
  saveState();
  renderStats();
  updateTrainerMeta();
  renderChart(currentChartRange);
  masteryRow.style.display = "flex";
}

checkBtn.addEventListener("click", () => checkAnswer(false));
showBtn.addEventListener("click", () => checkAnswer(true));
answerInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    checkAnswer(false);
  }
});

nextBtn.addEventListener("click", () => {
  nextQuestion();
});

memorizeBtn.addEventListener("click", () => {
  if (!currentQuestion) return;
  const stats = getVerbStats(currentQuestion.verbInf);
  stats.mastered = true;
  stats.needExtra = false;
  trainerFooter.textContent = `Okay, "${currentQuestion.verbInf}" is marked as mastered. It will appear less often.`;
  saveState();
});

keepBtn.addEventListener("click", () => {
  if (!currentQuestion) return;
  const stats = getVerbStats(currentQuestion.verbInf);
  stats.needExtra = true;
  stats.mastered = false;
  trainerFooter.textContent = `Got it. We’ll keep showing "${currentQuestion.verbInf}" more often until it feels automatic.`;
  saveState();
});

if (learnRow) {
  learnRow.addEventListener("click", function() { startTrainer("learn"); });
}
if (reviewRow) {
  reviewRow.addEventListener("click", function() { startTrainer("review"); });
}
if (mixedRow) {
  mixedRow.addEventListener("click", function() { startTrainer("mixed"); });
}

if (openGuideBtn && guideModal) {
  openGuideBtn.addEventListener("click", function() {
    guideModal.classList.add("show");
  });
}
if (guideCloseBtn && guideModal) {
  guideCloseBtn.addEventListener("click", function() {
    guideModal.classList.remove("show");
  });
}

if (openSettingsBtn) openSettingsBtn.addEventListener("click", function() {
  const current = state.settings.dailyTarget || 20;
  const val = prompt("Daily goal – how many new verbs per day?", String(current));
  if (!val) return;
  const n = parseInt(val, 10);
  if (!isFinite(n) || n <= 0) return;
  state.settings.dailyTarget = n;
  saveState();
  renderStats();
  renderChart(currentChartRange);
});

// initial render
renderDaysRow();
renderStats();
renderChart(currentChartRange);
updateTrainerMeta();
setTenseNote();
</script>
</body>
</html>
