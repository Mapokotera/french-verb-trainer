
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>French Verb Conjugation Trainer (B1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    :root {
      --bg: #0f172a;
      --bg-soft: #0b1220;
      --bg-card: #0f172a;
      --bg-card-soft: #020617;
      --border-subtle: #1e293b;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.14);
      --accent-strong: #1d4ed8;
      --danger: #ef4444;
      --success: #22c55e;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.65);
      --radius-lg: 18px;
      --radius-md: 999px;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #1d4ed8 0, #0b1120 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: linear-gradient(to right, rgba(15,23,42,0.96), rgba(15,23,42,0.94));
      border-bottom: 1px solid rgba(37, 99, 235, 0.35);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    header h1 {
      font-size: 20px;
      margin: 0 0 2px 0;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header h1 span.logo-dot {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #93c5fd, #1d4ed8);
      box-shadow: 0 0 18px rgba(59,130,246,0.9);
      flex-shrink: 0;
    }
    header small {
      font-size: 11px;
      color: var(--text-muted);
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    nav {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    nav button {
      border: none;
      padding: 8px 14px;
      border-radius: var(--radius-md);
      background: rgba(15,23,42,0.85);
      cursor: pointer;
      font-size: 13px;
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    nav button span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: transparent;
    }
    nav button.active {
      background: radial-gradient(circle at top left, rgba(59,130,246,0.55), rgba(15,23,42,0.9));
      color: #f9fafb;
      border-color: rgba(59,130,246,0.8);
      box-shadow: 0 10px 30px rgba(15,23,42,0.8);
    }
    nav button.active span.dot {
      background: #60a5fa;
    }
    .card {
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
      border-radius: var(--radius-lg);
      padding: 18px 16px 16px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin-bottom: 18px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
    }
    .subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .row > * {
      flex: 1 1 auto;
    }
    label {
      font-size: 11px;
      color: #cbd5f5;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: block;
      margin-bottom: 3px;
    }
    input[type="number"],
    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      font-size: 13px;
      margin-top: 0;
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      outline: none;
    }
    input[type="number"]:focus,
    input[type="text"]:focus,
    textarea:focus {
      border-color: rgba(59,130,246,0.9);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.3);
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    button.primary,
    button.secondary,
    button.danger {
      border-radius: var(--radius-md);
      border: none;
      font-size: 12px;
      padding: 7px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }
    button.primary {
      background: linear-gradient(to right, var(--accent), var(--accent-strong));
      color: #f9fafb;
      box-shadow: 0 12px 30px rgba(37,99,235,0.5);
    }
    button.primary:hover {
      background: linear-gradient(to right, var(--accent-strong), #1e40af);
    }
    button.secondary {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-main);
    }
    button.secondary:hover {
      border-color: rgba(148, 163, 184, 0.9);
    }
    button.danger {
      background: linear-gradient(to right, #ef4444, #b91c1c);
      color: #f9fafb;
    }
    button.small {
      padding: 4px 9px;
      font-size: 11px;
      border-radius: var(--radius-md);
    }
    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 9px;
      border-radius: var(--radius-md);
      background: rgba(15,23,42,0.9);
      font-size: 11px;
      margin-right: 4px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--text-muted);
    }
    .tag strong {
      color: #e5e7eb;
    }
    .tag.good {
      background: rgba(22,163,74,0.09);
      border-color: rgba(22,163,74,0.7);
      color: #bbf7d0;
    }
    .tag.bad {
      background: rgba(248,113,113,0.08);
      border-color: rgba(239,68,68,0.8);
      color: #fecaca;
    }
    .question-main {
      font-size: 16px;
      margin: 10px 0 6px 0;
    }
    .question-main span.label {
      font-weight: 500;
      color: var(--text-muted);
      font-size: 13px;
      margin-right: 6px;
    }
    .question-main span.value {
      font-weight: 600;
      color: #bfdbfe;
    }
    .pronoun {
      font-weight: 600;
      margin-right: 4px;
      padding: 2px 8px;
      border-radius: var(--radius-md);
      background: rgba(17,24,39,0.9);
      border: 1px solid rgba(59,130,246,0.5);
      font-size: 13px;
      color: #dbeafe;
    }
    .answer-row {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .feedback {
      margin-top: 8px;
      font-size: 13px;
      padding: 7px 9px;
      border-radius: 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.35);
      color: var(--text-muted);
    }
    .feedback.correct {
      border-color: rgba(34,197,94,0.85);
      background: rgba(22,163,74,0.08);
      color: #bbf7d0;
    }
    .feedback.incorrect {
      border-color: rgba(248,113,113,0.9);
      background: rgba(127,29,29,0.55);
      color: #fee2e2;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(30,64,175,0.4);
      text-align: left;
    }
    th {
      background: rgba(15,23,42,0.95);
      font-weight: 600;
      color: #c7d2fe;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .tense-grid {
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 8px;
      background: rgba(15,23,42,0.8);
    }
    .tense-grid h4 {
      margin: 0 0 6px 0;
      font-size: 13px;
      color: #bfdbfe;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .tense-grid h4 span.label-chip {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      background: rgba(15,23,42,0.9);
      border-radius: var(--radius-md);
      padding: 2px 6px;
      border: 1px solid rgba(148,163,184,0.4);
    }
    .tense-grid-row {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 4px 8px;
      margin-bottom: 4px;
      align-items: center;
    }
    .tense-grid-row label {
      margin: 0;
      font-size: 12px;
      text-transform: none;
      letter-spacing: 0;
      color: var(--text-muted);
    }
    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .pill-group button {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.45);
      cursor: pointer;
      background: rgba(15,23,42,0.8);
      color: var(--text-muted);
    }
    .pill-group button.active {
      background: rgba(37,99,235,0.2);
      color: #e5edff;
      border-color: rgba(59,130,246,0.85);
      box-shadow: 0 8px 22px rgba(37,99,235,0.65);
    }
    .small-muted {
      font-size: 11px;
      color: var(--text-muted);
    }
    .verb-list {
      max-height: 220px;
      overflow-y: auto;
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 8px;
      background: rgba(15,23,42,0.8);
    }
    .verb-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(30,64,175,0.5);
    }
    .verb-list-item:last-child {
      border-bottom: none;
    }
    .muted {
      color: var(--text-muted);
      font-size: 12px;
    }
    .chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-left: 6px;
    }
    .guide-grid {
      display: grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1fr);
      gap: 12px;
    }
    .guide-block {
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(30,64,175,0.7);
    }
    .guide-block h3 {
      margin: 0 0 4px 0;
      font-size: 14px;
      color: #dbeafe;
    }
    .guide-block p {
      margin: 4px 0;
      font-size: 12px;
      color: var(--text-muted);
    }
    .code {
      font-family: ui-monospace, Menlo, SFMono-Regular, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      background: rgba(15,23,42,0.85);
      border-radius: 8px;
      padding: 4px 6px;
      border: 1px solid rgba(30,64,175,0.8);
      display: inline-block;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(15,23,42,0.9);
    }
    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #60a5fa;
    }
    @media (max-width: 700px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .answer-row {
        flex-direction: column;
        align-items: stretch;
      }
      .row > * {
        flex: 1 1 100%;
      }
      .guide-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1><span class="logo-dot"></span>French Verb Trainer</h1>
    <small>B1-focused · offline · your verbs, your pace · bleu-powered</small>
  </div>
</header>

<div class="container">
  <nav>
    <button id="tab-trainer" class="active"><span class="dot"></span>Trainer</button>
    <button id="tab-review"><span class="dot"></span>Review & History</button>
    <button id="tab-manage"><span class="dot"></span>Verbs & Settings</button>
    <button id="tab-guide"><span class="dot"></span>Tense Guide</button>
  </nav>

  <!-- Trainer tab -->
  <section id="view-trainer" class="card">
    <h2>Daily session</h2>
    <div class="subtitle">
      Choose how many new verbs you want to unlock today. The trainer mixes new verbs with older ones for spaced repetition.
    </div>

    <div class="row" style="margin-bottom: 10px;">
      <div>
        <label>Mode</label>
        <div class="pill-group">
          <button id="mode-mixed" class="active">Mixed (new + review)</button>
          <button id="mode-reviewOnly">Review only</button>
        </div>
        <div class="small-muted">
          Mixed mode introduces new verbs until you hit your daily target, then switches to pure review.
        </div>
      </div>
      <div>
        <label for="dailyTarget">New verbs target / day</label>
        <div class="row">
          <input type="number" id="dailyTarget" min="1" max="500" value="20" style="max-width:120px;">
          <button id="saveSettingsBtn" class="small secondary">Save target</button>
        </div>
        <div class="small-muted" id="targetInfo"></div>
      </div>
    </div>

    <div class="row" style="margin-bottom: 10px;">
      <div>
        <label>Tenses to include in questions</label>
        <div id="tenseToggles" class="pill-group"></div>
        <div class="small-muted">
          You can, for example, start with Présent + Passé composé, then gradually add Imparfait, Futur, Conditionnel and Subjonctif présent.
        </div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid rgba(30,64,175,0.7);margin:12px 0;">

    <div id="statsBar" style="margin-bottom: 8px;"></div>

    <div id="questionCard" class="card" style="background:radial-gradient(circle at top left, rgba(30,64,175,0.60), rgba(15,23,42,0.98));box-shadow:none;border:1px solid rgba(59,130,246,0.9);">
      <div id="questionMeta" class="small-muted"></div>
      <div class="question-main" id="questionText"></div>
      <div class="answer-row">
        <div style="flex:1 1 auto;">
          <label for="answerInput">Your answer (verb form only)</label>
          <div class="row" style="gap:6px;align-items:center;">
            <span id="pronounDisplay" class="pronoun"></span>
            <input type="text" id="answerInput" placeholder="type the conjugated form (without the pronoun)">
          </div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button id="checkBtn" class="primary">Check</button>
          <button id="showBtn" class="secondary">Show answer</button>
          <button id="nextBtn" class="secondary" disabled>Next →</button>
        </div>
      </div>
      <div id="feedback" class="feedback"></div>
      <div class="small-muted" style="margin-top:6px;">
        Note: for <strong>passé composé</strong>, type the auxiliary + past participle (e.g. <span class="code">ai parlé</span>). For <strong>subjonctif</strong>, we practise the verb form without the <em>que</em>.
      </div>
    </div>
  </section>

  <!-- Review tab -->
  <section id="view-review" class="card" style="display:none;">
    <h2>Review & daily history</h2>
    <div class="subtitle">
      Track how many new verbs and review questions you’ve done and see how each verb is going over time.
    </div>

    <div class="card" style="background:rgba(15,23,42,0.95);box-shadow:none;border:1px solid rgba(30,64,175,0.7);">
      <h3 style="margin-top:0;font-size:15px;">Daily tracker</h3>
      <p class="small-muted">
        Each day, the trainer logs how many <strong>new verbs</strong> you met for the first time and how many <strong>review questions</strong> you answered.
      </p>
      <div id="historyTableWrapper"></div>
    </div>

    <div class="card" style="background:rgba(15,23,42,0.95);box-shadow:none;border:1px solid rgba(30,64,175,0.7);margin-top:12px;">
      <h3 style="margin-top:0;font-size:15px;">Verb-by-verb progress</h3>
      <p class="small-muted">
        Accuracy is a rough indicator; don’t worry about perfection. The goal is to keep revisiting verbs over time.
      </p>
      <div id="verbsProgressTableWrapper"></div>
    </div>
  </section>

  <!-- Manage tab -->
  <section id="view-manage" class="card" style="display:none;">
    <h2>Verbs & settings</h2>
    <div class="subtitle">
      Add new verbs (including irregular verbs), remove verbs, and curate the exact list you want to practise for B1.
    </div>

    <div class="card" style="background:rgba(15,23,42,0.95);box-shadow:none;border:1px solid rgba(30,64,175,0.7);">
      <h3 style="margin-top:0;font-size:15px;">Add / update verb</h3>
      <p class="small-muted">
        This system does <strong>no automatic conjugation</strong>. Whatever you type here is what the trainer uses, so irregular verbs are fully supported.
      </p>

      <div class="row" style="margin-bottom:8px;">
        <div>
          <label for="verbInfInput">Infinitive (Fr)</label>
          <input type="text" id="verbInfInput" placeholder="parler">
        </div>
        <div>
          <label for="verbEnInput">Meaning (EN, optional)</label>
          <input type="text" id="verbEnInput" placeholder="to speak">
        </div>
      </div>

      <div id="tensesEditorContainer"></div>

      <div class="row" style="margin-top:8px;">
        <button id="saveVerbBtn" class="primary">Save verb</button>
        <button id="clearVerbFormBtn" class="secondary">Clear form</button>
      </div>
      <div id="verbFormFeedback" class="feedback" style="margin-top:8px;"></div>
    </div>

    <div class="card" style="background:rgba(15,23,42,0.95);box-shadow:none;border:1px solid rgba(30,64,175,0.7);margin-top:12px;">
      <h3 style="margin-top:0;font-size:15px;">Current verb list</h3>
      <p class="small-muted">
        These verbs live on this device and are available for training. Deleting a verb also removes its progress stats.
      </p>
      <div id="verbList" class="verb-list"></div>
      <div class="small-muted" style="margin-top:6px;">
        Long-term goal: build this up towards a few hundred high-frequency verbs (you can aim for ~<strong>700+</strong> to feel very comfortable at B1 and beyond).
      </div>
    </div>
  </section>

  <!-- Tense Guide tab -->
  <section id="view-guide" class="card" style="display:none;">
    <h2>Tense guide (B1 focus)</h2>
    <div class="subtitle">
      Short, practical explanations for each tense you can train here, with patterns and examples. Think “cheat sheet” rather than formal grammar book.
    </div>

    <div class="guide-grid">
      <div class="guide-block">
        <h3>Présent</h3>
        <p><strong>Use it for:</strong> habits, facts, feelings, what’s happening now, near future with context.</p>
        <p><strong>Regular -er pattern (parler):</strong></p>
        <p class="code">je parle, tu parles, il parle, nous parlons, vous parlez, ils parlent</p>
        <p><strong>Examples:</strong></p>
        <p>Je travaille à Vancouver. <span class="small-muted">(I work in Vancouver.)</span></p>
        <p>On se voit demain ? <span class="small-muted">(Are we seeing each other tomorrow?)</span></p>
      </div>

      <div class="guide-block">
        <h3>Passé composé</h3>
        <p><strong>Use it for:</strong> completed events in the past, “what happened”, often with a clear time.</p>
        <p><strong>Structure:</strong> present of avoir/être + past participle</p>
        <p class="code">j'ai parlé, tu as parlé, il a parlé, nous avons parlé...</p>
        <p><strong>Examples:</strong></p>
        <p>J'ai fini le projet hier. <span class="small-muted">(I finished the project yesterday.)</span></p>
        <p>Elle est arrivée en retard. <span class="small-muted">(She arrived late.)</span></p>
      </div>
    </div>

    <div class="guide-grid" style="margin-top:10px;">
      <div class="guide-block">
        <h3>Imparfait</h3>
        <p><strong>Use it for:</strong> background, descriptions, habits in the past, “was doing / used to”.</p>
        <p><strong>Formation:</strong> nous form in présent (sans ons) + endings</p>
        <p class="code">parler → parl- + ais, ais, ait, ions, iez, aient</p>
        <p><strong>Examples:</strong></p>
        <p>Quand j'étais enfant, je jouais au foot tous les jours. <span class="small-muted">(When I was a child, I used to play football every day.)</span></p>
        <p>Il faisait froid et il pleuvait. <span class="small-muted">(It was cold and it was raining.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Futur proche & Futur simple</h3>
        <p><strong>Futur proche:</strong> near future, something already planned.</p>
        <p class="code">je vais parler, tu vas parler...</p>
        <p><strong>Futur simple:</strong> future in general, predictions, promises.</p>
        <p class="code">parler → parler- + ai, as, a, ons, ez, ont</p>
        <p><strong>Examples:</strong></p>
        <p>Je vais prendre le train à 18h. <span class="small-muted">(I’m going to take the train at 6 p.m.)</span></p>
        <p>On se reverra bientôt. <span class="small-muted">(We will see each other again soon.)</span></p>
      </div>
    </div>

    <div class="guide-grid" style="margin-top:10px;">
      <div class="guide-block">
        <h3>Conditionnel présent</h3>
        <p><strong>Use it for:</strong> politeness, wishes, hypotheses (“would”), advice.</p>
        <p><strong>Formation:</strong> futur simple stem + imparfait endings</p>
        <p class="code">parler → parler- + ais, ais, ait, ions, iez, aient</p>
        <p><strong>Examples:</strong></p>
        <p>Je voudrais un café, s'il vous plaît. <span class="small-muted">(I’d like a coffee, please.)</span></p>
        <p>Si j'avais plus de temps, je ferais plus de sport. <span class="small-muted">(If I had more time, I would do more sport.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Subjonctif présent</h3>
        <p><strong>Use it for:</strong> after certain expressions of doubt, necessity, emotion, desire.</p>
        <p><strong>Common triggers:</strong> il faut que, je veux que, bien que, pour que, avant que...</p>
        <p><strong>Pattern (parler):</strong></p>
        <p class="code">que je parle, que tu parles, qu'il parle, que nous parlions, que vous parliez, qu'ils parlent</p>
        <p><strong>Examples:</strong></p>
        <p>Il faut que tu finisses ce travail. <span class="small-muted">(You have to finish this work.)</span></p>
        <p>Je suis content que tu sois ici. <span class="small-muted">(I’m happy that you’re here.)</span></p>
      </div>
    </div>

    <div class="card" style="background:rgba(15,23,42,0.96);box-shadow:none;border:1px solid rgba(30,64,175,0.8);margin-top:12px;">
      <div class="badge"><span class="dot"></span>How this app uses these tenses</div>
      <p class="small-muted" style="margin-top:6px;">
        In the trainer, you always see the <strong>subject</strong> (je, tu, nous, etc.) and you type only the <strong>verb part</strong>.
        For composé forms, you type the auxiliary + participle (for example <span class="code">ai parlé</span>, <span class="code">suis allé</span>).
        For the subjonctif, we practise the conjugated form without writing <em>que</em> in front.
      </p>
      <p class="small-muted">
        If you’re rusty with grammar labels, don’t stress. Just associate each tense with a <strong>time / feeling</strong> (now, habit in the past,
        completed event, hypothesis, etc.) and keep practising until it feels natural.
      </p>
    </div>
  </section>
</div>

<script>
(function() {
  const STORAGE_KEY = 'frenchVerbTrainer_v1'; // same key so your existing data is kept

  const PRONOUNS = ["je","tu","il/elle","nous","vous","ils/elles"];
  const TENSES = [
    { id: "present", label: "Présent" },
    { id: "passe_compose", label: "Passé composé" },
    { id: "imparfait", label: "Imparfait" },
    { id: "futur_proche", label: "Futur proche" },
    { id: "futur_simple", label: "Futur simple" },
    { id: "conditionnel_present", label: "Conditionnel présent" },
    { id: "subjonctif_present", label: "Subjonctif présent" }
  ];

  const SEED_VERBS = [
    {
      inf: "être",
      en: "to be",
      tenses: {
        present: {
          "je": "suis",
          "tu": "es",
          "il/elle": "est",
          "nous": "sommes",
          "vous": "êtes",
          "ils/elles": "sont"
        },
        passe_compose: {
          "je": "ai été",
          "tu": "as été",
          "il/elle": "a été",
          "nous": "avons été",
          "vous": "avez été",
          "ils/elles": "ont été"
        },
        imparfait: {
          "je": "étais",
          "tu": "étais",
          "il/elle": "était",
          "nous": "étions",
          "vous": "étiez",
          "ils/elles": "étaient"
        },
        futur_simple: {
          "je": "serai",
          "tu": "seras",
          "il/elle": "sera",
          "nous": "serons",
          "vous": "serez",
          "ils/elles": "seront"
        },
        conditionnel_present: {
          "je": "serais",
          "tu": "serais",
          "il/elle": "serait",
          "nous": "serions",
          "vous": "seriez",
          "ils/elles": "seraient"
        },
        subjonctif_present: {
          "je": "sois",
          "tu": "sois",
          "il/elle": "soit",
          "nous": "soyons",
          "vous": "soyez",
          "ils/elles": "soient"
        }
      }
    },
    {
      inf: "avoir",
      en: "to have",
      tenses: {
        present: {
          "je": "ai",
          "tu": "as",
          "il/elle": "a",
          "nous": "avons",
          "vous": "avez",
          "ils/elles": "ont"
        },
        passe_compose: {
          "je": "ai eu",
          "tu": "as eu",
          "il/elle": "a eu",
          "nous": "avons eu",
          "vous": "avez eu",
          "ils/elles": "ont eu"
        },
        imparfait: {
          "je": "avais",
          "tu": "avais",
          "il/elle": "avait",
          "nous": "avions",
          "vous": "aviez",
          "ils/elles": "avaient"
        },
        futur_simple: {
          "je": "aurai",
          "tu": "auras",
          "il/elle": "aura",
          "nous": "aurons",
          "vous": "aurez",
          "ils/elles": "auront"
        },
        conditionnel_present: {
          "je": "aurais",
          "tu": "aurais",
          "il/elle": "aurait",
          "nous": "aurions",
          "vous": "auriez",
          "ils/elles": "auraient"
        },
        subjonctif_present: {
          "je": "aie",
          "tu": "aies",
          "il/elle": "ait",
          "nous": "ayons",
          "vous": "ayez",
          "ils/elles": "aient"
        }
      }
    },
    {
      inf: "aller",
      en: "to go",
      tenses: {
        present: {
          "je": "vais",
          "tu": "vas",
          "il/elle": "va",
          "nous": "allons",
          "vous": "allez",
          "ils/elles": "vont"
        },
        passe_compose: {
          "je": "suis allé",
          "tu": "es allé",
          "il/elle": "est allé",
          "nous": "sommes allés",
          "vous": "êtes allés",
          "ils/elles": "sont allés"
        },
        imparfait: {
          "je": "allais",
          "tu": "allais",
          "il/elle": "allait",
          "nous": "allions",
          "vous": "alliez",
          "ils/elles": "allaient"
        },
        futur_proche: {
          "je": "vais aller",
          "tu": "vas aller",
          "il/elle": "va aller",
          "nous": "allons aller",
          "vous": "allez aller",
          "ils/elles": "vont aller"
        },
        futur_simple: {
          "je": "irai",
          "tu": "iras",
          "il/elle": "ira",
          "nous": "irons",
          "vous": "irez",
          "ils/elles": "iront"
        },
        conditionnel_present: {
          "je": "irais",
          "tu": "irais",
          "il/elle": "irait",
          "nous": "irions",
          "vous": "iriez",
          "ils/elles": "iraient"
        },
        subjonctif_present: {
          "je": "aille",
          "tu": "ailles",
          "il/elle": "aille",
          "nous": "allions",
          "vous": "alliez",
          "ils/elles": "aillent"
        }
      }
    },
    {
      inf: "faire",
      en: "to do / to make",
      tenses: {
        present: {
          "je": "fais",
          "tu": "fais",
          "il/elle": "fait",
          "nous": "faisons",
          "vous": "faites",
          "ils/elles": "font"
        },
        passe_compose: {
          "je": "ai fait",
          "tu": "as fait",
          "il/elle": "a fait",
          "nous": "avons fait",
          "vous": "avez fait",
          "ils/elles": "ont fait"
        },
        imparfait: {
          "je": "faisais",
          "tu": "faisais",
          "il/elle": "faisait",
          "nous": "faisions",
          "vous": "faisiez",
          "ils/elles": "faisaient"
        },
        futur_simple: {
          "je": "ferai",
          "tu": "feras",
          "il/elle": "fera",
          "nous": "ferons",
          "vous": "ferez",
          "ils/elles": "feront"
        },
        conditionnel_present: {
          "je": "ferais",
          "tu": "ferais",
          "il/elle": "ferait",
          "nous": "ferions",
          "vous": "feriez",
          "ils/elles": "feraient"
        },
        subjonctif_present: {
          "je": "fasse",
          "tu": "fasses",
          "il/elle": "fasse",
          "nous": "fassions",
          "vous": "fassiez",
          "ils/elles": "fassent"
        }
      }
    },
    {
      inf: "parler",
      en: "to speak",
      tenses: {
        present: {
          "je": "parle",
          "tu": "parles",
          "il/elle": "parle",
          "nous": "parlons",
          "vous": "parlez",
          "ils/elles": "parlent"
        },
        passe_compose: {
          "je": "ai parlé",
          "tu": "as parlé",
          "il/elle": "a parlé",
          "nous": "avons parlé",
          "vous": "avez parlé",
          "ils/elles": "ont parlé"
        },
        imparfait: {
          "je": "parlais",
          "tu": "parlais",
          "il/elle": "parlait",
          "nous": "parlions",
          "vous": "parliez",
          "ils/elles": "parlaient"
        },
        futur_proche: {
          "je": "vais parler",
          "tu": "vas parler",
          "il/elle": "va parler",
          "nous": "allons parler",
          "vous": "allez parler",
          "ils/elles": "vont parler"
        },
        futur_simple: {
          "je": "parlerai",
          "tu": "parleras",
          "il/elle": "parlera",
          "nous": "parlerons",
          "vous": "parlerez",
          "ils/elles": "parleront"
        },
        conditionnel_present: {
          "je": "parlerais",
          "tu": "parlerais",
          "il/elle": "parlerait",
          "nous": "parlerions",
          "vous": "parleriez",
          "ils/elles": "parleraient"
        },
        subjonctif_present: {
          "je": "parle",
          "tu": "parles",
          "il/elle": "parle",
          "nous": "parlions",
          "vous": "parliez",
          "ils/elles": "parlent"
        }
      }
    },
    {
      inf: "finir",
      en: "to finish",
      tenses: {
        present: {
          "je": "finis",
          "tu": "finis",
          "il/elle": "finit",
          "nous": "finissons",
          "vous": "finissez",
          "ils/elles": "finissent"
        },
        passe_compose: {
          "je": "ai fini",
          "tu": "as fini",
          "il/elle": "a fini",
          "nous": "avons fini",
          "vous": "avez fini",
          "ils/elles": "ont fini"
        },
        imparfait: {
          "je": "finissais",
          "tu": "finissais",
          "il/elle": "finissait",
          "nous": "finissions",
          "vous": "finissiez",
          "ils/elles": "finissaient"
        },
        futur_simple: {
          "je": "finirai",
          "tu": "finiras",
          "il/elle": "finira",
          "nous": "finirons",
          "vous": "finirez",
          "ils/elles": "finiront"
        },
        conditionnel_present: {
          "je": "finirais",
          "tu": "finirais",
          "il/elle": "finirait",
          "nous": "finirions",
          "vous": "finiriez",
          "ils/elles": "finiraient"
        },
        subjonctif_present: {
          "je": "finisse",
          "tu": "finisses",
          "il/elle": "finisse",
          "nous": "finissions",
          "vous": "finissiez",
          "ils/elles": "finissent"
        }
      }
    }
  ];

  function todayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    let state;
    if (!raw) {
      state = {
        data: { verbs: {} },
        progress: {
          statsByVerb: {},
          historyByDate: {}
        },
        settings: {
          dailyNewTarget: 20,
          activeTenses: TENSES.map(t => t.id),
          mode: "mixed"
        }
      };
    } else {
      try {
        state = JSON.parse(raw);
      } catch (e) {
        console.warn("Failed to parse saved state, resetting.", e);
        state = {
          data: { verbs: {} },
          progress: {
            statsByVerb: {},
            historyByDate: {}
          },
          settings: {
            dailyNewTarget: 20,
            activeTenses: TENSES.map(t => t.id),
            mode: "mixed"
          }
        };
      }
    }
    if (!state.data) state.data = { verbs: {} };
    if (!state.data.verbs) state.data.verbs = {};
    if (!state.progress) state.progress = { statsByVerb: {}, historyByDate: {} };
    if (!state.progress.statsByVerb) state.progress.statsByVerb = {};
    if (!state.progress.historyByDate) state.progress.historyByDate = {};
    if (!state.settings) state.settings = {
      dailyNewTarget: 20,
      activeTenses: TENSES.map(t => t.id),
      mode: "mixed"
    };
    if (!Array.isArray(state.settings.activeTenses)) {
      state.settings.activeTenses = TENSES.map(t => t.id);
    }
    if (!state.settings.mode) state.settings.mode = "mixed";
    return state;
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.error("Failed to save state:", e);
    }
  }

  let state = loadState();
  const TODAY = todayStr();

  function seedVerbsIfEmpty() {
    if (Object.keys(state.data.verbs).length === 0) {
      SEED_VERBS.forEach(v => {
        state.data.verbs[v.inf] = v;
      });
      saveState();
    }
  }

  seedVerbsIfEmpty();

  function getAllVerbs() {
    return Object.values(state.data.verbs);
  }

  function getHistoryFor(dateStr) {
    if (!state.progress.historyByDate[dateStr]) {
      state.progress.historyByDate[dateStr] = {
        newCount: 0,
        reviewCount: 0
      };
    }
    return state.progress.historyByDate[dateStr];
  }

  function getStatsForVerb(inf) {
    if (!state.progress.statsByVerb[inf]) {
      state.progress.statsByVerb[inf] = {
        firstSeen: null,
        lastSeen: null,
        timesSeen: 0,
        correct: 0,
        wrong: 0
      };
    }
    return state.progress.statsByVerb[inf];
  }

  function randomChoice(arr) {
    if (!arr.length) return null;
    const idx = Math.floor(Math.random() * arr.length);
    return arr[idx];
  }

  function getActiveTenses() {
    return TENSES.filter(t => state.settings.activeTenses.includes(t.id));
  }

  let currentQuestion = null;
  let lastAnswered = null;

  function buildQuestion() {
    const verbs = getAllVerbs();
    const activeTenses = getActiveTenses();
    const statsByVerb = state.progress.statsByVerb;

    if (!verbs.length) return null;
    if (!activeTenses.length) return null;

    const unseen = verbs.filter(v => !statsByVerb[v.inf] || statsByVerb[v.inf].timesSeen === 0);
    const seen = verbs.filter(v => statsByVerb[v.inf] && statsByVerb[v.inf].timesSeen > 0);

    const historyToday = getHistoryFor(TODAY);
    const canIntroduceNew = (historyToday.newCount < state.settings.dailyNewTarget) && unseen.length > 0;

    let candidateVerbs = [];

    if (state.settings.mode === "reviewOnly") {
      candidateVerbs = seen.length ? seen : verbs;
    } else {
      if (canIntroduceNew) {
        if (Math.random() < 0.5 || seen.length === 0) {
          candidateVerbs = unseen;
        } else {
          candidateVerbs = seen;
        }
      } else {
        candidateVerbs = seen.length ? seen : verbs;
      }
    }

    let verb = randomChoice(candidateVerbs);
    if (!verb) verb = randomChoice(verbs);

    const availableTenses = activeTenses.filter(t => verb.tenses && verb.tenses[t.id]);
    if (!availableTenses.length) {
      const verbTenseIds = Object.keys(verb.tenses || {});
      if (!verbTenseIds.length) return null;
      const tId = randomChoice(verbTenseIds);
      const tenseDef = TENSES.find(t => t.id === tId) || { id: tId, label: tId };
      const persons = Object.keys(verb.tenses[tId]);
      const pronoun = randomChoice(persons);
      const correct = verb.tenses[tId][pronoun];
      return {
        verbInf: verb.inf,
        verbEn: verb.en || "",
        tenseId: tId,
        tenseLabel: tenseDef.label,
        pronoun: pronoun,
        answer: correct,
        isNewVerb: !statsByVerb[verb.inf] || statsByVerb[verb.inf].timesSeen === 0,
        isReviewVerb: statsByVerb[verb.inf] && statsByVerb[verb.inf].timesSeen > 0
      };
    }

    const tense = randomChoice(availableTenses);
    const persons = Object.keys(verb.tenses[tense.id]);
    const pronoun = randomChoice(persons);
    const correct = verb.tenses[tense.id][pronoun];

    return {
      verbInf: verb.inf,
      verbEn: verb.en || "",
      tenseId: tense.id,
      tenseLabel: tense.label,
      pronoun: pronoun,
      answer: correct,
      isNewVerb: !statsByVerb[verb.inf] || statsByVerb[verb.inf].timesSeen === 0,
      isReviewVerb: statsByVerb[verb.inf] && statsByVerb[verb.inf].timesSeen > 0
    };
  }

  function normaliseAnswer(str) {
    return (str || "").trim().toLowerCase();
  }

  const tabTrainerBtn = document.getElementById("tab-trainer");
  const tabReviewBtn = document.getElementById("tab-review");
  const tabManageBtn = document.getElementById("tab-manage");
  const tabGuideBtn = document.getElementById("tab-guide");

  const viewTrainer = document.getElementById("view-trainer");
  const viewReview = document.getElementById("view-review");
  const viewManage = document.getElementById("view-manage");
  const viewGuide = document.getElementById("view-guide");

  const dailyTargetInput = document.getElementById("dailyTarget");
  const saveSettingsBtn = document.getElementById("saveSettingsBtn");
  const targetInfo = document.getElementById("targetInfo");

  const tenseTogglesContainer = document.getElementById("tenseToggles");

  const statsBar = document.getElementById("statsBar");
  const questionMeta = document.getElementById("questionMeta");
  const questionText = document.getElementById("questionText");
  const pronounDisplay = document.getElementById("pronounDisplay");
  const answerInput = document.getElementById("answerInput");
  const checkBtn = document.getElementById("checkBtn");
  const showBtn = document.getElementById("showBtn");
  const nextBtn = document.getElementById("nextBtn");
  const feedbackEl = document.getElementById("feedback");

  const historyTableWrapper = document.getElementById("historyTableWrapper");
  const verbsProgressTableWrapper = document.getElementById("verbsProgressTableWrapper");

  const modeMixedBtn = document.getElementById("mode-mixed");
  const modeReviewOnlyBtn = document.getElementById("mode-reviewOnly");

  const tensesEditorContainer = document.getElementById("tensesEditorContainer");
  const verbInfInput = document.getElementById("verbInfInput");
  const verbEnInput = document.getElementById("verbEnInput");
  const saveVerbBtn = document.getElementById("saveVerbBtn");
  const clearVerbFormBtn = document.getElementById("clearVerbFormBtn");
  const verbFormFeedback = document.getElementById("verbFormFeedback");
  const verbListDiv = document.getElementById("verbList");

  function switchTab(tab) {
    const tabs = [
      { btn: tabTrainerBtn, view: viewTrainer, id: "trainer" },
      { btn: tabReviewBtn, view: viewReview, id: "review" },
      { btn: tabManageBtn, view: viewManage, id: "manage" },
      { btn: tabGuideBtn, view: viewGuide, id: "guide" }
    ];
    tabs.forEach(t => {
      const active = (t.id === tab);
      t.btn.classList.toggle("active", active);
      t.view.style.display = active ? "block" : "none";
    });
    if (tab === "review") {
      renderHistory();
      renderVerbsProgress();
    }
    if (tab === "manage") {
      renderVerbList();
    }
  }

  tabTrainerBtn.addEventListener("click", () => switchTab("trainer"));
  tabReviewBtn.addEventListener("click", () => switchTab("review"));
  tabManageBtn.addEventListener("click", () => switchTab("manage"));
  tabGuideBtn.addEventListener("click", () => switchTab("guide"));

  function renderTenseToggles() {
    tenseTogglesContainer.innerHTML = "";
    TENSES.forEach(t => {
      const btn = document.createElement("button");
      btn.textContent = t.label;
      btn.type = "button";
      btn.className = state.settings.activeTenses.includes(t.id) ? "active" : "";
      btn.addEventListener("click", () => {
        const idx = state.settings.activeTenses.indexOf(t.id);
        if (idx >= 0) {
          state.settings.activeTenses.splice(idx, 1);
        } else {
          state.settings.activeTenses.push(t.id);
        }
        saveState();
        renderTenseToggles();
      });
      tenseTogglesContainer.appendChild(btn);
    });
  }

  function renderStatsBar() {
    const historyToday = getHistoryFor(TODAY);
    const verbs = getAllVerbs();
    const seenCount = Object.values(state.progress.statsByVerb).filter(s => s.timesSeen > 0).length;

    statsBar.innerHTML = `
      <span class="tag">Today: <strong>${TODAY}</strong></span>
      <span class="tag good">New verbs today: <strong>${historyToday.newCount}</strong> / ${state.settings.dailyNewTarget}</span>
      <span class="tag">Review questions today: <strong>${historyToday.reviewCount}</strong></span>
      <span class="tag">Total verbs stored: <strong>${verbs.length}</strong></span>
      <span class="tag">Verbs seen at least once: <strong>${seenCount}</strong></span>
    `;
    targetInfo.textContent = `Aim: ${state.settings.dailyNewTarget} new verbs unlocked today. Adjust this to match your energy.`;
  }

  function renderQuestion() {
    if (!currentQuestion) {
      questionMeta.textContent = "No question available. Add some verbs with at least one tense in the Verbs & Settings tab.";
      questionText.textContent = "";
      pronounDisplay.textContent = "";
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      checkBtn.disabled = true;
      showBtn.disabled = true;
      nextBtn.disabled = false;
      return;
    }
    questionMeta.innerHTML = `
      Infinitive: <strong>${currentQuestion.verbInf}</strong>
      ${currentQuestion.verbEn ? ` · Meaning: <strong>${currentQuestion.verbEn}</strong>` : ""}
      · Tense: <strong>${currentQuestion.tenseLabel}</strong>
    `;
    questionText.innerHTML = `
      <span class="label">Conjugate for:</span>
      <span class="value">${currentQuestion.pronoun}</span>
    `;
    pronounDisplay.textContent = currentQuestion.pronoun;
    answerInput.value = "";
    answerInput.focus();
    feedbackEl.textContent = "";
    feedbackEl.className = "feedback";
    checkBtn.disabled = false;
    showBtn.disabled = false;
    nextBtn.disabled = true;
  }

  function newQuestion() {
    currentQuestion = buildQuestion();
    renderStatsBar();
    renderQuestion();
  }

  function handleCheck(showOnly) {
    if (!currentQuestion) return;
    const userAns = answerInput.value;
    const correctAns = currentQuestion.answer;

    const stats = getStatsForVerb(currentQuestion.verbInf);
    const history = getHistoryFor(TODAY);

    const wasFirst = !stats.firstSeen;
    stats.timesSeen += 1;
    stats.lastSeen = TODAY;
    if (!stats.firstSeen) {
      stats.firstSeen = TODAY;
      history.newCount += 1;
    } else {
      history.reviewCount += 1;
    }

    saveState();
    renderStatsBar();

    if (showOnly) {
      feedbackEl.textContent = `Answer: ${currentQuestion.pronoun} ${correctAns}`;
      feedbackEl.className = "feedback";
      checkBtn.disabled = true;
      showBtn.disabled = true;
      nextBtn.disabled = false;
      lastAnswered = { correct: null };
      return;
    }

    const ok = normaliseAnswer(userAns) === normaliseAnswer(correctAns);
    if (ok) {
      stats.correct += 1;
      feedbackEl.textContent = `Correct ✔  ${currentQuestion.pronoun} ${correctAns}`;
      feedbackEl.className = "feedback correct";
    } else {
      stats.wrong += 1;
      feedbackEl.textContent = `Not quite ✘  Your answer: "${userAns || "—"}" · Correct: ${currentQuestion.pronoun} ${correctAns}`;
      feedbackEl.className = "feedback incorrect";
    }
    saveState();
    lastAnswered = { correct: ok };
    checkBtn.disabled = true;
    showBtn.disabled = true;
    nextBtn.disabled = false;
  }

  checkBtn.addEventListener("click", () => handleCheck(false));
  showBtn.addEventListener("click", () => handleCheck(true));
  nextBtn.addEventListener("click", () => {
    newQuestion();
  });

  answerInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      if (!checkBtn.disabled) {
        handleCheck(false);
      } else if (!nextBtn.disabled) {
        newQuestion();
      }
    }
  });

  dailyTargetInput.value = state.settings.dailyNewTarget;
  saveSettingsBtn.addEventListener("click", () => {
    const val = parseInt(dailyTargetInput.value, 10);
    if (!isFinite(val) || val <= 0) {
      alert("Please enter a positive number for the daily target.");
      return;
    }
    state.settings.dailyNewTarget = val;
    saveState();
    renderStatsBar();
  });

  function updateModeButtons() {
    const mode = state.settings.mode;
    modeMixedBtn.classList.toggle("active", mode === "mixed");
    modeReviewOnlyBtn.classList.toggle("active", mode === "reviewOnly");
  }
  modeMixedBtn.addEventListener("click", () => {
    state.settings.mode = "mixed";
    saveState();
    updateModeButtons();
    newQuestion();
  });
  modeReviewOnlyBtn.addEventListener("click", () => {
    state.settings.mode = "reviewOnly";
    saveState();
    updateModeButtons();
    newQuestion();
  });

  function renderHistory() {
    const entries = Object.entries(state.progress.historyByDate);
    if (!entries.length) {
      historyTableWrapper.innerHTML = "<p class='muted'>No history yet. Start a session in the Trainer tab.</p>";
      return;
    }
    entries.sort((a, b) => a[0] < b[0] ? 1 : -1);
    const rows = entries.map(([date, h]) => `
      <tr>
        <td>${date}</td>
        <td>${h.newCount}</td>
        <td>${h.reviewCount}</td>
      </tr>
    `).join("");
    historyTableWrapper.innerHTML = `
      <div style="max-height:220px;overflow:auto;border-radius:10px;border:1px solid rgba(30,64,175,0.7);">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>New verbs introduced</th>
              <th>Review questions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function renderVerbsProgress() {
    const verbs = getAllVerbs();
    if (!verbs.length) {
      verbsProgressTableWrapper.innerHTML = "<p class='muted'>No verbs stored yet.</p>";
      return;
    }
    const rows = verbs.map(v => {
      const st = state.progress.statsByVerb[v.inf] || { firstSeen: null, lastSeen: null, timesSeen: 0, correct: 0, wrong: 0 };
      const total = st.correct + st.wrong;
      const acc = total ? Math.round(st.correct * 100 / total) : 0;
      return `
        <tr>
          <td>${v.inf}${v.en ? ` <span class="small-muted">(${v.en})</span>` : ""}</td>
          <td>${st.firstSeen || "—"}</td>
          <td>${st.lastSeen || "—"}</td>
          <td>${st.timesSeen}</td>
          <td>${st.correct}</td>
          <td>${st.wrong}</td>
          <td>${total ? acc + "%" : "—"}</td>
        </tr>
      `;
    }).join("");
    verbsProgressTableWrapper.innerHTML = `
      <div style="max-height:220px;overflow:auto;border-radius:10px;border:1px solid rgba(30,64,175,0.7);">
        <table>
          <thead>
            <tr>
              <th>Verb</th>
              <th>First seen</th>
              <th>Last seen</th>
              <th>Times asked</th>
              <th>Correct</th>
              <th>Wrong</th>
              <th>Accuracy</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function renderTensesEditor() {
    tensesEditorContainer.innerHTML = "";
    TENSES.forEach(t => {
      const wrapper = document.createElement("div");
      wrapper.className = "tense-grid";
      wrapper.dataset.tenseId = t.id;

      const title = document.createElement("h4");
      title.innerHTML = `${t.label} <span class="label-chip">Optional</span>`;
      wrapper.appendChild(title);

      PRONOUNS.forEach(p => {
        const row = document.createElement("div");
        row.className = "tense-grid-row";
        const lab = document.createElement("label");
        lab.textContent = p;
        const inp = document.createElement("input");
        inp.type = "text";
        inp.placeholder = "leave blank if you don’t want this form";
        inp.dataset.tenseId = t.id;
        inp.dataset.pronoun = p;
        row.appendChild(lab);
        row.appendChild(inp);
        wrapper.appendChild(row);
      });

      tensesEditorContainer.appendChild(wrapper);
    });
  }

  function clearVerbForm() {
    verbInfInput.value = "";
    verbEnInput.value = "";
    const inputs = tensesEditorContainer.querySelectorAll("input[type='text']");
    inputs.forEach(inp => {
      if (inp !== verbInfInput && inp !== verbEnInput) {
        inp.value = "";
      }
    });
    verbFormFeedback.textContent = "";
    verbFormFeedback.className = "feedback";
  }

  function saveVerbFromForm() {
    const inf = verbInfInput.value.trim();
    if (!inf) {
      verbFormFeedback.textContent = "Please enter at least the infinitive.";
      verbFormFeedback.className = "feedback incorrect";
      return;
    }
    const en = verbEnInput.value.trim();

    const tenseInputs = tensesEditorContainer.querySelectorAll("input[data-tense-id]");
    const tenses = {};
    tenseInputs.forEach(inp => {
      const val = inp.value.trim();
      const tid = inp.dataset.tenseId;
      const p = inp.dataset.pronoun;
      if (val) {
        if (!tenses[tid]) tenses[tid] = {};
        tenses[tid][p] = val;
      }
    });

    if (Object.keys(tenses).length === 0) {
      verbFormFeedback.textContent = "You didn’t fill any conjugations. Add at least one tense/person so it can be used in training.";
      verbFormFeedback.className = "feedback incorrect";
      return;
    }

    state.data.verbs[inf] = {
      inf,
      en,
      tenses
    };
    saveState();
    renderVerbList();
    verbFormFeedback.textContent = `Saved "${inf}". It is now available in the trainer.`;
    verbFormFeedback.className = "feedback correct";
  }

  saveVerbBtn.addEventListener("click", saveVerbFromForm);
  clearVerbFormBtn.addEventListener("click", clearVerbForm);

  function renderVerbList() {
    const verbs = getAllVerbs().sort((a, b) => a.inf.localeCompare(b.inf));
    if (!verbs.length) {
      verbListDiv.innerHTML = "<p class='muted'>No verbs stored yet. Add your first verbs above.</p>";
      return;
    }
    verbListDiv.innerHTML = "";
    verbs.forEach(v => {
      const item = document.createElement("div");
      item.className = "verb-list-item";
      const left = document.createElement("div");
      left.innerHTML = `<strong>${v.inf}</strong>${v.en ? ` <span class="small-muted">(${v.en})</span>` : ""}`;
      const right = document.createElement("div");
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.className = "small danger";
      delBtn.addEventListener("click", () => {
        if (confirm(`Remove verb "${v.inf}" and its progress?`)) {
          delete state.data.verbs[v.inf];
          delete state.progress.statsByVerb[v.inf];
          saveState();
          renderVerbList();
          renderStatsBar();
        }
      });
      right.appendChild(delBtn);
      item.appendChild(left);
      item.appendChild(right);
      verbListDiv.appendChild(item);
    });
  }

  renderTenseToggles();
  renderStatsBar();
  renderTensesEditor();
  renderVerbList();
  updateModeButtons();
  newQuestion();
})();
</script>
</body>
</html>
