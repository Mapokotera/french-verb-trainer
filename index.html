
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>French Verbs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-card: #ffffff;
      --bg-soft: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #e0ecff;
      --danger: #ef4444;
      --success: #16a34a;
      --border: #e5e7eb;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      height: 100%;
    }
    body {
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: linear-gradient(to bottom, #eef2ff 0, #f9fafb 80%);
      padding-bottom: 72px;
    }
    header {
      padding: 18px 20px 10px 20px;
    }
    header h1 {
      margin: 0;
      text-align: center;
      font-size: 22px;
      letter-spacing: 0.06em;
      text-transform: lowercase;
      color: #1d4ed8;
    }
    header small {
      display: block;
      text-align: center;
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }
    main {
      padding: 0 16px 16px 16px;
    }
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin: 10px 4px 6px 4px;
    }
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin-bottom: 12px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-header h2 {
      margin: 0;
      font-size: 16px;
    }
    .card-header span {
      font-size: 12px;
      color: var(--text-muted);
    }
    .mode-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 8px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.15s ease, transform 0.08s ease;
    }
    .mode-row:hover {
      background: #f3f4ff;
      transform: translateY(-1px);
    }
    .mode-row + .mode-row {
      border-top: 1px solid var(--border);
    }
    .mode-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .mode-icon {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: #dbeafe;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #1d4ed8;
      flex-shrink: 0;
    }
    .mode-text-title {
      font-size: 14px;
      font-weight: 600;
    }
    .mode-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }
    .mode-chevron {
      font-size: 16px;
      color: var(--text-muted);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--bg-soft);
      border: 1px solid #e5e7eb;
      font-size: 11px;
      color: var(--text-muted);
    }
    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .days-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 10px;
    }
    .day-dot {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-muted);
      background: #f3f4ff;
    }
    .day-dot.active {
      background: #1d4ed8;
      color: #eff6ff;
      font-weight: 600;
    }
    .streak-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .streak-card {
      flex: 1;
      background: var(--bg-soft);
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
    }
    .streak-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .streak-value {
      font-size: 18px;
      font-weight: 600;
    }
    .today-progress {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .circle {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 4px solid #e5e7eb;
      border-top-color: #2563eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }
    .today-text {
      font-size: 13px;
    }
    .today-sub {
      font-size: 12px;
      color: var(--text-muted);
    }
    .chart-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }
    .chart-tab {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
    }
    .chart-tab.active {
      border-color: #c7d2fe;
      background: #e0ecff;
      color: #1d4ed8;
    }
    .chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      height: 120px;
      gap: 6px;
      padding: 4px 0;
    }
    .bar-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }
    .bar {
      width: 14px;
      border-radius: 999px 999px 4px 4px;
      background: linear-gradient(to top, #f97316, #fde68a);
      transition: height 0.2s ease;
    }
    .bar-label {
      font-size: 10px;
      color: var(--text-muted);
    }
    .legend-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 11px;
      color: var(--text-muted);
    }
    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      margin-right: 4px;
      display: inline-block;
    }
    .legend-new { background: #f97316; }
    .legend-review { background: #60a5fa; }

    .link-row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
    }
    .link-row button {
      border: none;
      background: transparent;
      color: #2563eb;
      padding: 0;
      cursor: pointer;
    }

    /* Trainer overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.25);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .overlay.show {
      display: flex;
    }
    .trainer-sheet {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      background: #f9fafb;
      border-radius: 0;
      box-shadow: 0 -10px 30px rgba(15,23,42,0.2);
      display: flex;
      flex-direction: column;
    }
    .trainer-header {
      padding: 10px 14px 6px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #e5e7eb;
      background: #ffffff;
    }
    .trainer-header button {
      border: none;
      background: #eff6ff;
      border-radius: 999px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #1d4ed8;
      cursor: pointer;
    }
    .trainer-header-title {
      display: flex;
      flex-direction: column;
    }
    .trainer-header-title span:first-child {
      font-size: 14px;
      font-weight: 600;
    }
    .trainer-header-title span:last-child {
      font-size: 12px;
      color: var(--text-muted);
    }
    .trainer-body {
      padding: 10px 14px 14px 14px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
    }
    .trainer-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 11px;
    }
    .trainer-card {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 12px 12px 10px 12px;
      border: 1px solid #e5e7eb;
      box-shadow: var(--shadow-soft);
    }
    .trainer-q-main {
      font-size: 16px;
      margin-bottom: 6px;
    }
    .trainer-q-main strong {
      font-size: 17px;
    }
    .trainer-q-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .pronoun-pill {
      display: inline-flex;
      padding: 3px 9px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 12px;
      margin-right: 6px;
    }
    .answer-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .answer-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 8px 11px;
      font-size: 14px;
      outline: none;
    }
    .answer-row input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #bfdbfe;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(to right, #2563eb, #1d4ed8);
      color: #f9fafb;
      box-shadow: 0 12px 22px rgba(37, 99, 235, 0.35);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn:disabled {
      opacity: 0.6;
      box-shadow: none;
      cursor: default;
    }
    .feedback {
      margin-top: 8px;
      font-size: 13px;
      padding: 6px 9px;
      border-radius: 12px;
      background: #f3f4ff;
      color: #1f2937;
      border: 1px solid #e5e7eb;
    }
    .feedback.correct {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: #166534;
    }
    .feedback.incorrect {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
    }
    .tense-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }
    .trainer-footer {
      padding: 8px 14px 10px 14px;
      border-top: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 11px;
      color: var(--text-muted);
    }
    .trainer-footer strong {
      color: #111827;
    }

    /* Tense guide modal */
    .guide-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.32);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .guide-modal.show {
      display: flex;
    }
    .guide-sheet {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      background: #ffffff;
      border-radius: 0;
      display: flex;
      flex-direction: column;
    }
    .guide-header {
      padding: 10px 14px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .guide-header button {
      border: none;
      background: #eff6ff;
      border-radius: 999px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #1d4ed8;
      cursor: pointer;
    }
    .guide-header h2 {
      margin: 0;
      font-size: 16px;
    }
    .guide-body {
      padding: 10px 14px 16px 14px;
      overflow-y: auto;
      flex: 1;
      font-size: 13px;
      color: #111827;
    }
    .guide-block {
      margin-bottom: 12px;
      padding: 10px 10px 8px 10px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .guide-block h3 {
      margin: 0 0 4px 0;
      font-size: 14px;
      color: #1d4ed8;
    }
    .guide-block p {
      margin: 3px 0;
    }
    .code {
      font-family: ui-monospace, Menlo, SFMono-Regular, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      background: #e5e7eb;
      border-radius: 6px;
      padding: 2px 5px;
    }
    .small-muted {
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (max-width: 480px) {
      .app {
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>French Verbs</h1>
    <small>Present first · unlock new tenses as you go</small>
  </header>
  <main>
    <div class="section-title">Spaced repetition</div>
    <section class="card">
      <div class="card-header">
        <h2>Practice</h2>
        <span id="currentTenseLabel">Current tense: Présent</span>
      </div>

      <div class="mode-row" data-mode="learn">
        <div class="mode-main">
          <div class="mode-icon">＋</div>
          <div>
            <div class="mode-text-title">Learn new verbs</div>
            <div class="mode-text-sub" id="learnSub">Unlock your daily quota of new verbs.</div>
          </div>
        </div>
        <div class="mode-chevron">›</div>
      </div>

      <div class="mode-row" data-mode="review">
        <div class="mode-main">
          <div class="mode-icon">⟳</div>
          <div>
            <div class="mode-text-title">Review verbs</div>
            <div class="mode-text-sub" id="reviewSub">Focused review of verbs you’ve already seen.</div>
          </div>
        </div>
        <div class="mode-chevron">›</div>
      </div>

      <div class="mode-row" data-mode="mixed">
        <div class="mode-main">
          <div class="mode-icon">✦</div>
          <div>
            <div class="mode-text-title">Mixed mode</div>
            <div class="mode-text-sub" id="mixedSub">Mix new verbs with review for variety.</div>
          </div>
        </div>
        <div class="mode-chevron">›</div>
      </div>
    </section>

    <div class="section-title">Stats</div>
    <section class="card">
      <div class="days-row" id="daysRow"></div>

      <div class="streak-row">
        <div class="streak-card">
          <div class="streak-label">Current streak</div>
          <div class="streak-value" id="currentStreak">0</div>
        </div>
        <div class="streak-card">
          <div class="streak-label">Best streak</div>
          <div class="streak-value" id="bestStreak">0</div>
        </div>
      </div>

      <div class="today-progress">
        <div class="circle" id="todayCircle">0</div>
        <div>
          <div class="today-text">Learned today: <span id="todayLearned">0</span>/<span id="dailyGoalText">20</span></div>
          <div class="today-sub" id="todaySubLabel">Tap a mode above to start today’s session.</div>
        </div>
      </div>

      <div class="chart-tabs">
        <button class="chart-tab active" data-range="7">7 days</button>
        <button class="chart-tab" data-range="30">30 days</button>
        <button class="chart-tab" data-range="90">90 days</button>
      </div>
      <div class="chart" id="chart"></div>
      <div class="legend-row">
        <div><span class="legend-color legend-new"></span>New verbs</div>
        <div><span class="legend-color legend-review"></span>Review questions</div>
      </div>

      <div class="link-row">
        <button id="openGuideBtn">Tense guide</button>
        <button id="openSettingsBtn">Daily goal & reset</button>
      </div>
    </section>
  </main>
</div>

<!-- Trainer overlay -->
<div class="overlay" id="trainerOverlay">
  <div class="trainer-sheet">
    <div class="trainer-header">
      <button id="trainerBackBtn">‹</button>
      <div class="trainer-header-title">
        <span id="trainerModeTitle">Learn new verbs</span>
        <span id="trainerModeSub">Présent · type the verb form only</span>
      </div>
    </div>
    <div class="trainer-body">
      <div class="trainer-meta">
        <span class="pill"><span class="pill-dot"></span> Today: <span id="trainerTodayCount">0</span> questions</span>
        <span class="pill">Accuracy: <span id="trainerAccuracy">0%</span></span>
        <span class="pill" id="trainerUnlockedLabel">Unlocked: Présent</span>
      </div>
      <div class="trainer-card">
        <div class="trainer-q-main" id="questionMain">Tap a mode to start.</div>
        <div class="trainer-q-sub" id="questionSub"></div>
        <div class="answer-row">
          <input type="text" id="answerInput" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="type the conjugated form (verb only)">
          <button class="btn btn-primary" id="checkBtn">Check</button>
          <button class="btn btn-secondary" id="showBtn">Show</button>
        </div>
        <div id="feedback" class="feedback" style="display:none;"></div>
        <div class="tense-note" id="tenseNote"></div>
      </div>
    </div>
    <div class="trainer-footer">
      <span id="unlockMessage"></span>
    </div>
  </div>
</div>

<!-- Tense guide modal -->
<div class="guide-modal" id="guideModal">
  <div class="guide-sheet">
    <div class="guide-header">
      <button id="guideCloseBtn">‹</button>
      <h2>Tense guide</h2>
    </div>
    <div class="guide-body">
      <div class="guide-block">
        <h3>Présent</h3>
        <p><strong>Use it for:</strong> habits, facts, feelings, things happening now, or very near future when the context is clear.</p>
        <p><strong>Regular -er pattern (parler):</strong></p>
        <p class="code">je parle, tu parles, il parle, nous parlons, vous parlez, ils parlent</p>
        <p><strong>Regular -ir pattern (finir):</strong></p>
        <p class="code">je finis, tu finis, il finit, nous finissons, vous finissez, ils finissent</p>
        <p><strong>Regular -re pattern (vendre):</strong></p>
        <p class="code">je vends, tu vends, il vend, nous vendons, vous vendez, ils vendent</p>
        <p><strong>Examples:</strong></p>
        <p>Je travaille à Vancouver. <span class="small-muted">(I work in Vancouver.)</span></p>
        <p>On se voit demain ? <span class="small-muted">(Are we seeing each other tomorrow?)</span></p>
      </div>

      <div class="guide-block">
        <h3>Passé composé</h3>
        <p><strong>Use it for:</strong> completed events in the past, “what happened”.</p>
        <p><strong>Structure:</strong> présent of <em>avoir</em> or <em>être</em> + past participle.</p>
        <p class="code">j'ai parlé, tu as parlé, il a parlé, nous avons parlé...</p>
        <p><strong>With être (movement / reflexive verbs):</strong></p>
        <p class="code">je suis allé(e), elle est arrivée, nous sommes partis</p>
        <p><strong>Examples:</strong></p>
        <p>J'ai fini le projet hier. <span class="small-muted">(I finished the project yesterday.)</span></p>
        <p>Elle est arrivée en retard. <span class="small-muted">(She arrived late.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Imparfait</h3>
        <p><strong>Use it for:</strong> background, descriptions, habits in the past, “was doing / used to”.</p>
        <p><strong>How to build it:</strong> take <em>nous</em> in the present, remove <em>-ons</em>, add:</p>
        <p class="code">-ais, -ais, -ait, -ions, -iez, -aient</p>
        <p><strong>Example (parler):</strong></p>
        <p class="code">nous parlons → je parlais, tu parlais, il parlait, nous parlions, vous parliez, ils parlaient</p>
        <p><strong>Examples:</strong></p>
        <p>Quand j'étais enfant, je jouais dehors tous les jours. <span class="small-muted">(When I was a child, I used to play outside every day.)</span></p>
        <p>Il faisait froid et il pleuvait. <span class="small-muted">(It was cold and it was raining.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Futur simple</h3>
        <p><strong>Use it for:</strong> future in general, promises, predictions.</p>
        <p><strong>Pattern (-er, -ir):</strong> infinitive + endings:</p>
        <p class="code">-ai, -as, -a, -ons, -ez, -ont</p>
        <p><strong>Example (parler):</strong></p>
        <p class="code">je parlerai, tu parleras, il parlera, nous parlerons, vous parlerez, ils parleront</p>
        <p><strong>Examples:</strong></p>
        <p>On se reverra bientôt. <span class="small-muted">(We will see each other again soon.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Conditionnel présent</h3>
        <p><strong>Use it for:</strong> politeness, wishes, hypotheses (“would”), advice.</p>
        <p><strong>Pattern:</strong> futur simple stem + imparfait endings.</p>
        <p class="code">je parlerais, tu parlerais, il parlerait, nous parlerions, vous parleriez, ils parleraient</p>
        <p><strong>Examples:</strong></p>
        <p>Je voudrais un café, s'il vous plaît. <span class="small-muted">(I’d like a coffee, please.)</span></p>
        <p>Si j'avais plus de temps, je ferais plus de sport. <span class="small-muted">(If I had more time, I would do more sport.)</span></p>
      </div>

      <div class="guide-block">
        <h3>Subjonctif présent</h3>
        <p><strong>Use it for:</strong> after certain expressions of doubt, necessity, emotion, desire.</p>
        <p><strong>Common triggers:</strong> il faut que, je veux que, je suis content que, bien que, pour que, avant que…</p>
        <p><strong>Pattern (parler):</strong></p>
        <p class="code">que je parle, que tu parles, qu'il parle, que nous parlions, que vous parliez, qu'ils parlent</p>
        <p><strong>Examples:</strong></p>
        <p>Il faut que tu finisses ce travail. <span class="small-muted">(You have to finish this work.)</span></p>
        <p>Je suis content que tu sois ici. <span class="small-muted">(I’m happy that you’re here.)</span></p>
      </div>

      <p class="small-muted">
        In the trainer you always see the subject (je, tu, nous, etc.) and you type only the <strong>verb form</strong>.
        For composé forms, type the auxiliary + past participle (for example <span class="code">ai parlé</span>).
        For the subjonctif, we practise the conjugated form without writing <em>que</em>.
      </p>
    </div>
  </div>
</div>

<script>
const INITIAL_VERBS = [
  { inf: 'accepter', en: 'to accept', group: 'er' },
  { inf: 'accompagner', en: 'to accompany', group: 'er' },
  { inf: 'accomplir', en: 'to accomplish', group: 'ir' },
  { inf: 'acheter', en: 'to buy', group: 'er' },
  { inf: 'adorer', en: 'to adore', group: 'er' },
  { inf: 'afficher', en: 'to display', group: 'er' },
  { inf: 'agir', en: 'to act', group: 'ir' },
  { inf: 'aider', en: 'to help', group: 'er' },
  { inf: 'aimer', en: 'to like / to love', group: 'er' },
  { inf: 'aller', en: 'to go', group: 'irreg' },
  { inf: 'améliorer', en: 'to improve', group: 'er' },
  { inf: 'annoncer', en: 'to announce', group: 'er' },
  { inf: 'annuler', en: 'to cancel', group: 'er' },
  { inf: 'apparaître', en: 'to appear', group: 'irreg' },
  { inf: 'appeler', en: 'to call (on the phone)', group: 'er' },
  { inf: 'apporter', en: 'to bring (a thing)', group: 'er' },
  { inf: 'apprendre', en: 'to learn', group: 'irreg' },
  { inf: 'approcher', en: 'to approach', group: 'er' },
  { inf: 'apprécier', en: 'to appreciate', group: 'er' },
  { inf: 'arranger', en: 'to arrange', group: 'er' },
  { inf: 'arriver', en: 'to arrive', group: 'er' },
  { inf: 'arrêter', en: 'to stop', group: 'er' },
  { inf: 'assister', en: 'to attend', group: 'er' },
  { inf: 'atteindre', en: 'to reach', group: 'irreg' },
  { inf: 'attendre', en: 'to wait', group: 're' },
  { inf: 'attirer', en: 'to attract', group: 'er' },
  { inf: 'avancer', en: 'to advance', group: 'er' },
  { inf: 'avoir', en: 'to have', group: 'irreg' },
  { inf: 'baisser', en: 'to lower', group: 'er' },
  { inf: 'bavarder', en: 'to chat', group: 'er' },
  { inf: 'boire', en: 'to drink', group: 'irreg' },
  { inf: 'bouger', en: 'to move', group: 'er' },
  { inf: 'brancher', en: 'to plug in', group: 'er' },
  { inf: 'briller', en: 'to shine', group: 'er' },
  { inf: 'brûler', en: 'to burn', group: 'er' },
  { inf: 'casser', en: 'to break', group: 'er' },
  { inf: 'changer', en: 'to change', group: 'er' },
  { inf: 'chanter', en: 'to sing', group: 'er' },
  { inf: 'charger', en: 'to load / to charge', group: 'er' },
  { inf: 'chercher', en: 'to look for', group: 'er' },
  { inf: 'choisir', en: 'to choose', group: 'ir' },
  { inf: 'classer', en: 'to classify', group: 'er' },
  { inf: 'cliquer', en: 'to click', group: 'er' },
  { inf: 'collaborer', en: 'to collaborate', group: 'er' },
  { inf: 'coller', en: 'to stick / to paste', group: 'er' },
  { inf: 'commencer', en: 'to begin', group: 'er' },
  { inf: 'comparer', en: 'to compare', group: 'er' },
  { inf: 'compter', en: 'to count', group: 'er' },
  { inf: 'conduire', en: 'to drive', group: 'irreg' },
  { inf: 'confirmer', en: 'to confirm', group: 'er' },
  { inf: 'confondre', en: 'to confuse', group: 're' },
  { inf: 'connaître', en: 'to know (someone / place)', group: 'irreg' },
  { inf: 'connecter', en: 'to connect', group: 'er' },
  { inf: 'conseiller', en: 'to advise', group: 'er' },
  { inf: 'construire', en: 'to build', group: 'irreg' },
  { inf: 'continuer', en: 'to continue', group: 'er' },
  { inf: 'coordonner', en: 'to coordinate', group: 'er' },
  { inf: 'correspondre', en: 'to correspond', group: 're' },
  { inf: 'corriger', en: 'to correct', group: 'er' },
  { inf: 'coûter', en: 'to cost', group: 'er' },
  { inf: 'croire', en: 'to believe', group: 'irreg' },
  { inf: 'créer', en: 'to create', group: 'er' },
  { inf: 'cuisiner', en: 'to cook', group: 'er' },
  { inf: 'danser', en: 'to dance', group: 'er' },
  { inf: 'demander', en: 'to ask', group: 'er' },
  { inf: 'descendre', en: 'to go down / to descend', group: 're' },
  { inf: 'dessiner', en: 'to draw', group: 'er' },
  { inf: 'devenir', en: 'to become', group: 'irreg' },
  { inf: 'devoir', en: 'to have to / must', group: 'irreg' },
  { inf: 'dire', en: 'to say / to tell', group: 'irreg' },
  { inf: 'diriger', en: 'to lead / to manage', group: 'er' },
  { inf: 'discuter', en: 'to discuss', group: 'er' },
  { inf: 'disparaître', en: 'to disappear', group: 'irreg' },
  { inf: 'donner', en: 'to give', group: 'er' },
  { inf: 'dormir', en: 'to sleep', group: 'irreg' },
  { inf: 'durer', en: 'to last', group: 'er' },
  { inf: 'débrancher', en: 'to unplug', group: 'er' },
  { inf: 'décider', en: 'to decide', group: 'er' },
  { inf: 'découvrir', en: 'to discover', group: 'irreg' },
  { inf: 'détester', en: 'to hate', group: 'er' },
  { inf: 'développer', en: 'to develop', group: 'er' },
  { inf: 'emmener', en: 'to take (someone)', group: 'er' },
  { inf: 'emprunter', en: 'to borrow', group: 'er' },
  { inf: 'empêcher', en: 'to prevent', group: 'er' },
  { inf: 'enlever', en: 'to remove', group: 'er' },
  { inf: 'enseigner', en: 'to teach', group: 'er' },
  { inf: 'entendre', en: 'to hear', group: 're' },
  { inf: 'entrainer', en: 'to train / to coach', group: 'er' },
  { inf: 'entrer', en: 'to enter', group: 'er' },
  { inf: 'envoyer', en: 'to send', group: 'er' },
  { inf: 'espérer', en: 'to hope', group: 'er' },
  { inf: 'essayer', en: 'to try', group: 'er' },
  { inf: 'examiner', en: 'to examine', group: 'er' },
  { inf: 'exister', en: 'to exist', group: 'er' },
  { inf: 'expliquer', en: 'to explain', group: 'er' },
  { inf: 'exprimer', en: 'to express', group: 'er' },
  { inf: 'faire', en: 'to do / to make', group: 'irreg' },
  { inf: 'fermer', en: 'to close', group: 'er' },
  { inf: 'filmer', en: 'to film', group: 'er' },
  { inf: 'finir', en: 'to finish', group: 'ir' },
  { inf: 'fondre', en: 'to melt', group: 're' },
  { inf: 'former', en: 'to train / to form', group: 'er' },
  { inf: 'fumer', en: 'to smoke', group: 'er' },
  { inf: 'gagner', en: 'to win / to earn', group: 'er' },
  { inf: 'garder', en: 'to keep', group: 'er' },
  { inf: 'grandir', en: 'to grow', group: 'ir' },
  { inf: 'grossir', en: 'to gain weight', group: 'ir' },
  { inf: 'gérer', en: 'to manage', group: 'er' },
  { inf: 'habiter', en: 'to live (somewhere)', group: 'er' },
  { inf: 'imaginer', en: 'to imagine', group: 'er' },
  { inf: 'imposer', en: 'to impose', group: 'er' },
  { inf: 'imprimer', en: 'to print', group: 'er' },
  { inf: 'indiquer', en: 'to indicate', group: 'er' },
  { inf: 'informer', en: 'to inform', group: 'er' },
  { inf: 'installer', en: 'to install', group: 'er' },
  { inf: 'invite', en: 'to invite', group: 'er' },
  { inf: 'inviter', en: 'to invite', group: 'er' },
  { inf: 'joindre', en: 'to attach / join', group: 'irreg' },
  { inf: 'jouer', en: 'to play', group: 'er' },
  { inf: 'lancer', en: 'to launch / to throw', group: 'er' },
  { inf: 'laver', en: 'to wash', group: 'er' },
  { inf: 'limiter', en: 'to limit', group: 'er' },
  { inf: 'lire', en: 'to read', group: 'irreg' },
  { inf: 'maigrir', en: 'to lose weight', group: 'ir' },
  { inf: 'manger', en: 'to eat', group: 'er' },
  { inf: 'manquer', en: 'to miss', group: 'er' },
  { inf: 'marcher', en: 'to walk', group: 'er' },
  { inf: 'mesurer', en: 'to measure', group: 'er' },
  { inf: 'mettre', en: 'to put / to place', group: 'irreg' },
  { inf: 'monter', en: 'to go up / to climb', group: 'er' },
  { inf: 'montrer', en: 'to show', group: 'er' },
  { inf: 'mourir', en: 'to die', group: 'irreg' },
  { inf: 'nager', en: 'to swim', group: 'er' },
  { inf: 'naître', en: 'to be born', group: 'irreg' },
  { inf: 'nettoyer', en: 'to clean', group: 'er' },
  { inf: 'noter', en: 'to note / to grade', group: 'er' },
  { inf: 'obéir', en: 'to obey', group: 'ir' },
  { inf: 'offrir', en: 'to offer', group: 'irreg' },
  { inf: 'organiser', en: 'to organize', group: 'er' },
  { inf: 'oublier', en: 'to forget', group: 'er' },
  { inf: 'ouvrir', en: 'to open', group: 'irreg' },
  { inf: 'pardonner', en: 'to forgive', group: 'er' },
  { inf: 'parler', en: 'to speak', group: 'er' },
  { inf: 'participer', en: 'to take part', group: 'er' },
  { inf: 'partir', en: 'to leave', group: 'irreg' },
  { inf: 'passer', en: 'to pass / to spend (time)', group: 'er' },
  { inf: 'payer', en: 'to pay', group: 'er' },
  { inf: 'penser', en: 'to think', group: 'er' },
  { inf: 'perdre', en: 'to lose', group: 're' },
  { inf: 'permettre', en: 'to allow', group: 'irreg' },
  { inf: 'plaisanter', en: 'to joke', group: 'er' },
  { inf: 'planifier', en: 'to plan', group: 'er' },
  { inf: 'plier', en: 'to fold', group: 'er' },
  { inf: 'pointer', en: 'to point', group: 'er' },
  { inf: 'porter', en: 'to wear / to carry', group: 'er' },
  { inf: 'poser', en: 'to put down / to pose', group: 'er' },
  { inf: 'pousser', en: 'to push', group: 'er' },
  { inf: 'pouvoir', en: 'to be able to / can', group: 'irreg' },
  { inf: 'prendre', en: 'to take', group: 'irreg' },
  { inf: 'produire', en: 'to produce', group: 'irreg' },
  { inf: 'progresser', en: 'to progress', group: 'er' },
  { inf: 'prolonger', en: 'to extend / to prolong', group: 'er' },
  { inf: 'promettre', en: 'to promise', group: 'irreg' },
  { inf: 'proposer', en: 'to propose / to suggest', group: 'er' },
  { inf: 'protéger', en: 'to protect', group: 'er' },
  { inf: 'préparer', en: 'to prepare', group: 'er' },
  { inf: 'prévenir', en: 'to warn', group: 'irreg' },
  { inf: 'prévoir', en: 'to plan / to foresee', group: 'irreg' },
  { inf: 'prêter', en: 'to lend', group: 'er' },
  { inf: 'publier', en: 'to publish', group: 'er' },
  { inf: 'punir', en: 'to punish', group: 'ir' },
  { inf: 'raconter', en: 'to tell (a story)', group: 'er' },
  { inf: 'ranger', en: 'to tidy / to put away', group: 'er' },
  { inf: 'recevoir', en: 'to receive', group: 'irreg' },
  { inf: 'reconnaître', en: 'to recognize', group: 'irreg' },
  { inf: 'refuser', en: 'to refuse', group: 'er' },
  { inf: 'regarder', en: 'to look at', group: 'er' },
  { inf: 'rejoindre', en: 'to join', group: 'irreg' },
  { inf: 'relier', en: 'to link', group: 'er' },
  { inf: 'remarquer', en: 'to notice', group: 'er' },
  { inf: 'remettre', en: 'to put back', group: 'irreg' },
  { inf: 'remonter', en: 'to go back up', group: 'er' },
  { inf: 'remplacer', en: 'to replace', group: 'er' },
  { inf: 'remplir', en: 'to fill', group: 'ir' },
  { inf: 'rencontrer', en: 'to meet', group: 'er' },
  { inf: 'rendre', en: 'to give back', group: 're' },
  { inf: 'rentrer', en: 'to return (home)', group: 'er' },
  { inf: 'renvoyer', en: 'to send back', group: 'er' },
  { inf: 'respecter', en: 'to respect', group: 'er' },
  { inf: 'respirer', en: 'to breathe', group: 'er' },
  { inf: 'rester', en: 'to stay', group: 'er' },
  { inf: 'retourner', en: 'to return', group: 'er' },
  { inf: 'revenir', en: 'to come back', group: 'irreg' },
  { inf: 'rire', en: 'to laugh', group: 'irreg' },
  { inf: 'réagir', en: 'to react', group: 'ir' },
  { inf: 'réfléchir', en: 'to think / to reflect', group: 'ir' },
  { inf: 'réparer', en: 'to repair', group: 'er' },
  { inf: 'répondre', en: 'to answer', group: 're' },
  { inf: 'réserver', en: 'to book / to reserve', group: 'er' },
  { inf: 'réussir', en: 'to succeed', group: 'ir' },
  { inf: 'rêver', en: 'to dream', group: 'er' },
  { inf: 'sauter', en: 'to jump', group: 'er' },
  { inf: 'sauver', en: 'to save', group: 'er' },
  { inf: 'savoir', en: 'to know (a fact)', group: 'irreg' },
  { inf: 'se coucher', en: 'to go to bed', group: 'er' },
  { inf: 'se dépêcher', en: 'to hurry', group: 'er' },
  { inf: 'se laver', en: 'to wash oneself', group: 'er' },
  { inf: 'se lever', en: 'to get up', group: 'er' },
  { inf: 'se promener', en: 'to go for a walk', group: 'er' },
  { inf: 'se préparer', en: 'to get ready', group: 'er' },
  { inf: 'se rappeler', en: 'to remember', group: 'er' },
  { inf: 'se reposer', en: 'to rest', group: 'er' },
  { inf: 'se souvenir', en: 'to remember', group: 'irreg' },
  { inf: 'servir', en: 'to serve', group: 'irreg' },
  { inf: 'signaler', en: 'to signal / to report', group: 'er' },
  { inf: 'signer', en: 'to sign', group: 'er' },
  { inf: 'sortir', en: 'to go out', group: 'irreg' },
  { inf: 'souhaiter', en: 'to wish', group: 'er' },
  { inf: 'sourire', en: 'to smile', group: 'irreg' },
  { inf: 'soutenir', en: 'to support', group: 'irreg' },
  { inf: 'souvenir', en: 'to remember', group: 'irreg' },
  { inf: 'suggérer', en: 'to suggest', group: 'er' },
  { inf: 'supporter', en: 'to support', group: 'er' },
  { inf: 'sélectionner', en: 'to select', group: 'er' },
  { inf: 'séparer', en: 'to separate', group: 'er' },
  { inf: 's’amuser', en: 'to have fun', group: 'er' },
  { inf: 'terminer', en: 'to finish', group: 'er' },
  { inf: 'tester', en: 'to test', group: 'er' },
  { inf: 'tirer', en: 'to pull / to shoot', group: 'er' },
  { inf: 'tomber', en: 'to fall', group: 'er' },
  { inf: 'toucher', en: 'to touch', group: 'er' },
  { inf: 'tourner', en: 'to turn', group: 'er' },
  { inf: 'traduire', en: 'to translate', group: 'irreg' },
  { inf: 'travailler', en: 'to work', group: 'er' },
  { inf: 'trouver', en: 'to find', group: 'er' },
  { inf: 'télécharger', en: 'to download', group: 'er' },
  { inf: 'utiliser', en: 'to use', group: 'er' },
  { inf: 'vendre', en: 'to sell', group: 're' },
  { inf: 'venir', en: 'to come', group: 'irreg' },
  { inf: 'visiter', en: 'to visit', group: 'er' },
  { inf: 'voir', en: 'to see', group: 'irreg' },
  { inf: 'voler', en: 'to steal / to fly', group: 'er' },
  { inf: 'vouloir', en: 'to want', group: 'irreg' },
  { inf: 'vérifier', en: 'to check', group: 'er' },
  { inf: 'économiser', en: 'to save (money)', group: 'er' },
  { inf: 'écouter', en: 'to listen', group: 'er' },
  { inf: 'écrire', en: 'to write', group: 'irreg' },
  { inf: 'étudier', en: 'to study', group: 'er' },
  { inf: 'éviter', en: 'to avoid', group: 'er' },
  { inf: 'être', en: 'to be', group: 'irreg' },
];

const STORAGE_KEY = 'frenchVerbApp_v1';

const PRONOUNS = ["je","tu","il/elle","nous","vous","ils/elles"];
const DAY_LABELS = ["S","M","T","W","T","F","S"];

const TENSES = [
  { id: "present", label: "Présent" },
  { id: "passe_compose", label: "Passé composé" },
  { id: "imparfait", label: "Imparfait" },
  { id: "futur_simple", label: "Futur simple" },
  { id: "conditionnel_present", label: "Conditionnel présent" },
  { id: "subjonctif_present", label: "Subjonctif présent" }
];

const TENSE_UNLOCK_RULES = {
  passe_compose: { require: "present", minQuestions: 80, minAccuracy: 0.8 },
  imparfait: { require: "passe_compose", minQuestions: 80, minAccuracy: 0.8 },
  futur_simple: { require: "imparfait", minQuestions: 60, minAccuracy: 0.8 },
  conditionnel_present: { require: "futur_simple", minQuestions: 60, minAccuracy: 0.8 },
  subjonctif_present: { require: "conditionnel_present", minQuestions: 60, minAccuracy: 0.75 }
};

// irregular present forms for key verbs
const IRREGULAR_PRESENT = {
  "être": { "je":"suis","tu":"es","il/elle":"est","nous":"sommes","vous":"êtes","ils/elles":"sont" },
  "avoir": { "je":"ai","tu":"as","il/elle":"a","nous":"avons","vous":"avez","ils/elles":"ont" },
  "aller": { "je":"vais","tu":"vas","il/elle":"va","nous":"allons","vous":"allez","ils/elles":"vont" },
  "faire": { "je":"fais","tu":"fais","il/elle":"fait","nous":"faisons","vous":"faites","ils/elles":"font" },
  "dire": { "je":"dis","tu":"dis","il/elle":"dit","nous":"disons","vous":"dites","ils/elles":"disent" },
  "pouvoir": { "je":"peux","tu":"peux","il/elle":"peut","nous":"pouvons","vous":"pouvez","ils/elles":"peuvent" },
  "vouloir": { "je":"veux","tu":"veux","il/elle":"veut","nous":"voulons","vous":"voulez","ils/elles":"veulent" },
  "devoir": { "je":"dois","tu":"dois","il/elle":"doit","nous":"devons","vous":"devez","ils/elles":"doivent" },
  "savoir": { "je":"sais","tu":"sais","il/elle":"sait","nous":"savons","vous":"savez","ils/elles":"savent" },
  "connaître": { "je":"connais","tu":"connais","il/elle":"connaît","nous":"connaissons","vous":"connaissez","ils/elles":"connaissent" },
  "venir": { "je":"viens","tu":"viens","il/elle":"vient","nous":"venons","vous":"venez","ils/elles":"viennent" },
  "prendre": { "je":"prends","tu":"prends","il/elle":"prend","nous":"prenons","vous":"prenez","ils/elles":"prennent" },
  "mettre": { "je":"mets","tu":"mets","il/elle":"met","nous":"mettons","vous":"mettez","ils/elles":"mettent" },
  "voir": { "je":"vois","tu":"vois","il/elle":"voit","nous":"voyons","vous":"voyez","ils/elles":"voient" },
  "croire": { "je":"crois","tu":"crois","il/elle":"croit","nous":"croyons","vous":"croyez","ils/elles":"croient" },
  "sortir": { "je":"sors","tu":"sors","il/elle":"sort","nous":"sortons","vous":"sortez","ils/elles":"sortent" },
  "partir": { "je":"pars","tu":"pars","il/elle":"part","nous":"partons","vous":"partez","ils/elles":"partent" },
  "dormir": { "je":"dors","tu":"dors","il/elle":"dort","nous":"dormons","vous":"dormez","ils/elles":"dorment" },
  "servir": { "je":"sers","tu":"sers","il/elle":"sert","nous":"servons","vous":"servez","ils/elles":"servent" },
  "écrire": { "je":"écris","tu":"écris","il/elle":"écrit","nous":"écrivons","vous":"écrivez","ils/elles":"écrivent" },
  "lire": { "je":"lis","tu":"lis","il/elle":"lit","nous":"lisons","vous":"lisez","ils/elles":"lisent" },
  "boire": { "je":"bois","tu":"bois","il/elle":"boit","nous":"buvons","vous":"buvez","ils/elles":"boivent" },
  "ouvrir": { "je":"ouvre","tu":"ouvres","il/elle":"ouvre","nous":"ouvrons","vous":"ouvrez","ils/elles":"ouvrent" },
  "offrir": { "je":"offre","tu":"offres","il/elle":"offre","nous":"offrons","vous":"offrez","ils/elles":"offrent" },
  "recevoir": { "je":"reçois","tu":"reçois","il/elle":"reçoit","nous":"recevons","vous":"recevez","ils/elles":"reçoivent" },
  "naître": { "je":"nais","tu":"nais","il/elle":"naît","nous":"naissons","vous":"naissez","ils/elles":"naissent" },
  "mourir": { "je":"meurs","tu":"meurs","il/elle":"meurt","nous":"mourons","vous":"mourez","ils/elles":"meurent" },
  "devenir": { "je":"deviens","tu":"deviens","il/elle":"devient","nous":"devenons","vous":"devenez","ils/elles":"deviennent" },
  "rire": { "je":"ris","tu":"ris","il/elle":"rit","nous":"rions","vous":"riez","ils/elles":"rient" },
  "sourire": { "je":"souris","tu":"souris","il/elle":"sourit","nous":"sourions","vous":"souriez","ils/elles":"sourient" },
  "conduire": { "je":"conduis","tu":"conduis","il/elle":"conduit","nous":"conduisons","vous":"conduisez","ils/elles":"conduisent" },
  "construire": { "je":"construis","tu":"construis","il/elle":"construit","nous":"construisons","vous":"construisez","ils/elles":"construisent" },
  "produire": { "je":"produis","tu":"produis","il/elle":"produit","nous":"produisons","vous":"produisez","ils/elles":"produisent" },
  "traduire": { "je":"traduis","tu":"traduis","il/elle":"traduit","nous":"traduisons","vous":"traduisez","ils/elles":"traduisent" },
  "joindre": { "je":"joins","tu":"joins","il/elle":"joint","nous":"joignons","vous":"joignez","ils/elles":"joignent" },
  "rejoindre": { "je":"rejoins","tu":"rejoins","il/elle":"rejoint","nous":"rejoignons","vous":"rejoignez","ils/elles":"rejoignent" },
  "reconnaître": { "je":"reconnais","tu":"reconnais","il/elle":"reconnaît","nous":"reconnaissons","vous":"reconnaissez","ils/elles":"reconnaissent" },
  "apparaître": { "je":"apparais","tu":"apparais","il/elle":"apparaît","nous":"apparaissons","vous":"apparaissez","ils/elles":"apparaissent" },
  "disparaître": { "je":"disparais","tu":"disparais","il/elle":"disparaît","nous":"disparaissons","vous":"disparaissez","ils/elles":"disparaissent" },
  "atteindre": { "je":"atteins","tu":"atteins","il/elle":"atteint","nous":"atteignons","vous":"atteignez","ils/elles":"atteignent" },
  "apprendre": { "je":"apprends","tu":"apprends","il/elle":"apprend","nous":"apprenons","vous":"apprenez","ils/elles":"apprennent" },
  "promettre": { "je":"promets","tu":"promets","il/elle":"promet","nous":"promettons","vous":"promettez","ils/elles":"promettent" },
  "permettre": { "je":"permets","tu":"permets","il/elle":"permet","nous":"permettons","vous":"permettez","ils/elles":"permettent" },
  "remettre": { "je":"remets","tu":"remets","il/elle":"remet","nous":"remettons","vous":"remettez","ils/elles":"remettent" },
  "prévenir": { "je":"préviens","tu":"préviens","il/elle":"prévient","nous":"prévenons","vous":"prévenez","ils/elles":"préviennent" },
  "prévoir": { "je":"prévois","tu":"prévois","il/elle":"prévoit","nous":"prévoyons","vous":"prévoyez","ils/elles":"prévoient" }
};

// NOTE: some irregulars above (prévenir / prévoir) may not be perfect in every form;
// if a form looks strange, you can correct it by adding your own verb entry later.

function todayStr() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    return {
      verbs: INITIAL_VERBS,
      progress: {
        perVerb: {},
        historyByDate: {},
        tenseStats: {},
        streak: { current: 0, best: 0, lastDate: null },
        unlockedTenses: ["present"]
      },
      settings: {
        dailyTarget: 20
      }
    };
  }
  try {
    const parsed = JSON.parse(raw);
    if (!parsed.verbs) parsed.verbs = INITIAL_VERBS;
    if (!parsed.progress) parsed.progress = { perVerb:{}, historyByDate:{}, tenseStats:{}, streak:{current:0,best:0,lastDate:null}, unlockedTenses:["present"] };
    if (!parsed.progress.perVerb) parsed.progress.perVerb = {};
    if (!parsed.progress.historyByDate) parsed.progress.historyByDate = {};
    if (!parsed.progress.tenseStats) parsed.progress.tenseStats = {};
    if (!parsed.progress.streak) parsed.progress.streak = { current:0,best:0,lastDate:null };
    if (!parsed.progress.unlockedTenses) parsed.progress.unlockedTenses = ["present"];
    if (!parsed.settings) parsed.settings = { dailyTarget: 20 };
    return parsed;
  } catch (e) {
    console.warn("Failed to parse saved state, resetting.", e);
    return {
      verbs: INITIAL_VERBS,
      progress: {
        perVerb: {},
        historyByDate: {},
        tenseStats: {},
        streak: { current: 0, best: 0, lastDate: null },
        unlockedTenses: ["present"]
      },
      settings: {
        dailyTarget: 20
      }
    };
  }
}

let state = loadState();
const TODAY = todayStr();

function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.error("Failed to save state:", e);
  }
}

function getHistory(dateStr) {
  if (!state.progress.historyByDate[dateStr]) {
    state.progress.historyByDate[dateStr] = {
      newCount: 0,
      reviewCount: 0,
      correct: 0,
      wrong: 0
    };
  }
  return state.progress.historyByDate[dateStr];
}

function getTenseStats(tenseId) {
  if (!state.progress.tenseStats[tenseId]) {
    state.progress.tenseStats[tenseId] = { asked: 0, correct: 0, wrong: 0 };
  }
  return state.progress.tenseStats[tenseId];
}

function getVerbStats(inf) {
  if (!state.progress.perVerb[inf]) {
    state.progress.perVerb[inf] = { timesSeen: 0, correct: 0, wrong: 0, firstSeen: null, lastSeen: null };
  }
  return state.progress.perVerb[inf];
}

function updateStreak() {
  const streak = state.progress.streak;
  const last = streak.lastDate;
  const today = TODAY;
  if (last === today) {
    return;
  }
  if (!last) {
    streak.current = 1;
  } else {
    const lastDateObj = new Date(last);
    const todayDateObj = new Date(today);
    const diff = (todayDateObj - lastDateObj) / (1000*60*60*24);
    if (diff <= 1.5 && diff >= 0.5) {
      streak.current += 1;
    } else {
      streak.current = 1;
    }
  }
  if (streak.current > streak.best) streak.best = streak.current;
  streak.lastDate = today;
}

function conjugatePresent(verb, pronoun) {
  const inf = verb.inf;
  if (IRREGULAR_PRESENT[inf]) {
    return IRREGULAR_PRESENT[inf][pronoun] || null;
  }
  // ignore reflexive verbs for now
  if (inf.startsWith("se ") || inf.startsWith("s'") || inf.startsWith("s’")) {
    return null;
  }
  const group = verb.group;
  if (group === "er") {
    // remove -er
    const stem = inf.slice(0, -2);
    if (pronoun === "je") return stem + "e";
    if (pronoun === "tu") return stem + "es";
    if (pronoun === "il/elle") return stem + "e";
    if (pronoun === "nous") return stem + "ons";
    if (pronoun === "vous") return stem + "ez";
    if (pronoun === "ils/elles") return stem + "ent";
  } else if (group === "ir") {
    // finir-type
    const stem = inf.slice(0, -2);
    if (pronoun === "je") return stem + "is";
    if (pronoun === "tu") return stem + "is";
    if (pronoun === "il/elle") return stem + "it";
    if (pronoun === "nous") return stem + "issons";
    if (pronoun === "vous") return stem + "issez";
    if (pronoun === "ils/elles") return stem + "issent";
  } else if (group === "re") {
    const stem = inf.slice(0, -2);
    if (pronoun === "je") return stem + "s";
    if (pronoun === "tu") return stem + "s";
    if (pronoun === "il/elle") return stem;
    if (pronoun === "nous") return stem + "ons";
    if (pronoun === "vous") return stem + "ez";
    if (pronoun === "ils/elles") return stem + "ent";
  }
  return null;
}

// For now we only actually ask Présent questions; future tenses can be added later
function getConjugation(verb, tenseId, pronoun) {
  if (tenseId === "present") {
    return conjugatePresent(verb, pronoun);
  }
  // other tenses can be added gradually here
  return null;
}

function availableTenses() {
  return state.progress.unlockedTenses.slice();
}

function randomChoice(arr) {
  if (!arr.length) return null;
  const idx = Math.floor(Math.random() * arr.length);
  return arr[idx];
}

function buildQuestion(mode) {
  const verbs = state.verbs;
  const unlocked = availableTenses();
  if (!unlocked.length) return null;
  // for now, pick only present even if more unlocked,
  // but structure already supports future tenses
  const tenseId = "present";
  const tenseLabel = "Présent";
  const stats = state.progress.perVerb;

  const unseen = verbs.filter(v => !stats[v.inf] || stats[v.inf].timesSeen === 0)
                      .filter(v => getConjugation(v, tenseId, "je"));
  const seen = verbs.filter(v => stats[v.inf] && stats[v.inf].timesSeen > 0)
                    .filter(v => getConjugation(v, tenseId, "je"));

  let pool = [];
  if (mode === "learn") {
    pool = unseen.length ? unseen : seen;
  } else if (mode === "review") {
    pool = seen.length ? seen : unseen;
  } else {
    // mixed
    if (Math.random() < 0.5 && unseen.length) pool = unseen;
    else pool = seen.length ? seen : unseen;
  }
  if (!pool.length) pool = verbs;

  const verb = randomChoice(pool);
  const pronoun = randomChoice(PRONOUNS);
  const answer = getConjugation(verb, tenseId, pronoun);
  if (!answer) return buildQuestion(mode); // skip unsupported verb
  return {
    verbInf: verb.inf,
    verbEn: verb.en,
    tenseId,
    tenseLabel,
    pronoun,
    answer
  };
}

function normalise(str) {
  return (str || "").trim().toLowerCase();
}

// DOM
const daysRow = document.getElementById("daysRow");
const currentStreakEl = document.getElementById("currentStreak");
const bestStreakEl = document.getElementById("bestStreak");
const todayCircle = document.getElementById("todayCircle");
const todayLearnedEl = document.getElementById("todayLearned");
const dailyGoalText = document.getElementById("dailyGoalText");
const todaySubLabel = document.getElementById("todaySubLabel");
const chartEl = document.getElementById("chart");
const chartTabs = document.querySelectorAll(".chart-tab");
const currentTenseLabel = document.getElementById("currentTenseLabel");

const trainerOverlay = document.getElementById("trainerOverlay");
const trainerBackBtn = document.getElementById("trainerBackBtn");
const trainerModeTitle = document.getElementById("trainerModeTitle");
const trainerModeSub = document.getElementById("trainerModeSub");
const trainerTodayCount = document.getElementById("trainerTodayCount");
const trainerAccuracy = document.getElementById("trainerAccuracy");
const trainerUnlockedLabel = document.getElementById("trainerUnlockedLabel");
const trainerFooter = document.getElementById("unlockMessage");

const questionMain = document.getElementById("questionMain");
const questionSub = document.getElementById("questionSub");
const answerInput = document.getElementById("answerInput");
const checkBtn = document.getElementById("checkBtn");
const showBtn = document.getElementById("showBtn");
const feedbackEl = document.getElementById("feedback");
const tenseNote = document.getElementById("tenseNote");

const openGuideBtn = document.getElementById("openGuideBtn");
const openSettingsBtn = document.getElementById("openSettingsBtn");
const guideModal = document.getElementById("guideModal");
const guideCloseBtn = document.getElementById("guideCloseBtn");
const learnRow = document.querySelector('.mode-row[data-mode="learn"]');
const reviewRow = document.querySelector('.mode-row[data-mode="review"]');
const mixedRow = document.querySelector('.mode-row[data-mode="mixed"]');

const trainerMetaTodayPill = document.querySelector(".pill span");

let currentMode = null;
let currentQuestion = null;

function renderDaysRow() {
  const todayIndex = new Date().getDay(); // 0 Sunday
  daysRow.innerHTML = "";
  for (let i = 0; i < 7; i++) {
    const d = document.createElement("div");
    d.className = "day-dot" + (i === todayIndex ? " active" : "");
    d.textContent = DAY_LABELS[i];
    daysRow.appendChild(d);
  }
}

function renderStats() {
  const histToday = getHistory(TODAY);
  todayLearnedEl.textContent = histToday.newCount;
  dailyGoalText.textContent = state.settings.dailyTarget;
  const pct = Math.min(100, (histToday.newCount / state.settings.dailyTarget) * 100);
  todayCircle.textContent = histToday.newCount;
  todayCircle.style.borderTopColor = pct >= 100 ? "#16a34a" : "#2563eb";

  currentStreakEl.textContent = state.progress.streak.current;
  bestStreakEl.textContent = state.progress.streak.best;

  currentTenseLabel.textContent = "Current tense: Présent (others unlock as you progress)";
}

function renderChart(rangeDays) {
  const bars = [];
  const todayDate = new Date(TODAY);
  for (let i = rangeDays - 1; i >= 0; i--) {
    const d = new Date(todayDate);
    d.setDate(d.getDate() - i);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const key = `${y}-${m}-${day}`;
    const h = state.progress.historyByDate[key] || { newCount:0, reviewCount:0 };
    bars.push({ date:key.slice(5), new:h.newCount || 0, review:h.reviewCount || 0 });
  }
  const max = Math.max(1, ...bars.map(b => b.new + b.review));
  chartEl.innerHTML = "";
  bars.forEach(b => {
    const col = document.createElement("div");
    col.className = "bar-col";
    const totalHeight = (b.new + b.review) / max * 100;
    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.height = `${totalHeight}%`;
    col.appendChild(bar);
    const label = document.createElement("div");
    label.className = "bar-label";
    label.textContent = b.date.slice(3);
    col.appendChild(label);
    chartEl.appendChild(col);
  });
}

chartTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    chartTabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    const range = parseInt(tab.dataset.range, 10);
    renderChart(range);
  });
});

function updateTrainerMeta() {
  const hist = getHistory(TODAY);
  trainerTodayCount.textContent = hist.newCount + hist.reviewCount;
  const total = hist.correct + hist.wrong;
  const acc = total ? Math.round(hist.correct * 100 / total) : 0;
  trainerAccuracy.textContent = acc + "%";
  trainerUnlockedLabel.textContent = "Unlocked: Présent (more tenses later)";
}

function setTenseNoteFor(tenseId) {
  if (tenseId === "present") {
    tenseNote.textContent = "Présent: think about what is true now, in general, or very near future. Type only the verb form, without the pronoun.";
  } else {
    tenseNote.textContent = "";
  }
}

function startTrainer(mode) {
  currentMode = mode;
  trainerOverlay.classList.add("show");
  trainerFooter.textContent = "";
  if (mode === "learn") {
    trainerModeTitle.textContent = "Learn new verbs";
    trainerModeSub.textContent = "Présent · new verbs first, then light review";
  } else if (mode === "review") {
    trainerModeTitle.textContent = "Review verbs";
    trainerModeSub.textContent = "Présent · mostly verbs you’ve already seen";
  } else {
    trainerModeTitle.textContent = "Mixed mode";
    trainerModeSub.textContent = "Présent · mix of new and review";
  }
  updateTrainerMeta();
  nextQuestion();
  // prevent page from scrolling behind overlay
  document.body.style.overflow = "hidden";
}

function closeTrainer() {
  trainerOverlay.classList.remove("show");
  currentMode = null;
  currentQuestion = null;
  feedbackEl.style.display = "none";
  document.body.style.overflow = "";
}

trainerBackBtn.addEventListener("click", closeTrainer);

function nextQuestion() {
  if (!currentMode) return;
  currentQuestion = buildQuestion(currentMode);
  if (!currentQuestion) {
    questionMain.textContent = "No question available. Something went wrong.";
    questionSub.textContent = "";
    return;
  }
  questionMain.innerHTML = `<span class="pronoun-pill">${currentQuestion.pronoun}</span> <strong>${currentQuestion.verbInf}</strong>`;
  questionSub.textContent = (currentQuestion.verbEn ? currentQuestion.verbEn + " · " : "") + currentQuestion.tenseLabel + " – type only the verb form.";
  answerInput.value = "";
  answerInput.focus();
  feedbackEl.style.display = "none";
  setTenseNoteFor(currentQuestion.tenseId);
}

function checkAnswer(showOnly) {
  if (!currentQuestion) return;
  const hist = getHistory(TODAY);
  const verbStats = getVerbStats(currentQuestion.verbInf);
  const tenseStats = getTenseStats(currentQuestion.tenseId);

  if (showOnly) {
    feedbackEl.style.display = "block";
    feedbackEl.className = "feedback";
    feedbackEl.textContent = `Correct form: ${currentQuestion.pronoun} ${currentQuestion.answer}`;
    return;
  }

  const user = answerInput.value;
  const ok = normalise(user) === normalise(currentQuestion.answer);

  verbStats.timesSeen += 1;
  verbStats.lastSeen = TODAY;
  if (!verbStats.firstSeen) {
    verbStats.firstSeen = TODAY;
    hist.newCount += 1;
  } else {
    hist.reviewCount += 1;
  }

  if (ok) {
    verbStats.correct += 1;
    hist.correct += 1;
    tenseStats.correct += 1;
    feedbackEl.style.display = "block";
    feedbackEl.className = "feedback correct";
    feedbackEl.textContent = `Nice ✔  ${currentQuestion.pronoun} ${currentQuestion.answer}`;
  } else {
    verbStats.wrong += 1;
    hist.wrong += 1;
    tenseStats.wrong += 1;
    feedbackEl.style.display = "block";
    feedbackEl.className = "feedback incorrect";
    feedbackEl.textContent = `Not quite ✘  You typed "${user || "—"}". Correct: ${currentQuestion.pronoun} ${currentQuestion.answer}`;
  }
  tenseStats.asked += 1;
  updateStreak();
  saveState();
  renderStats();
  updateTrainerMeta();
  checkUnlocks();
  setTimeout(nextQuestion, 400);
}

checkBtn.addEventListener("click", () => checkAnswer(false));
showBtn.addEventListener("click", () => checkAnswer(true));
answerInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    checkAnswer(false);
  }
});

function checkUnlocks() {
  // For now only display gentle message placeholder; future tenses can be unlocked here.
  trainerFooter.textContent = "Keep going in Présent. Once you reach a stable accuracy, the app can introduce Passé composé and others.";
}

learnRow.addEventListener("click", () => startTrainer("learn"));
reviewRow.addEventListener("click", () => startTrainer("review"));
mixedRow.addEventListener("click", () => startTrainer("mixed"));

openGuideBtn.addEventListener("click", () => {
  guideModal.classList.add("show");
});
guideCloseBtn.addEventListener("click", () => {
  guideModal.classList.remove("show");
});

openSettingsBtn.addEventListener("click", () => {
  const current = state.settings.dailyTarget || 20;
  const val = prompt("Daily goal – how many new verbs per day?", String(current));
  if (!val) return;
  const n = parseInt(val, 10);
  if (!isFinite(n) || n <= 0) return;
  state.settings.dailyTarget = n;
  saveState();
  renderStats();
});

// initial render
renderDaysRow();
renderStats();
renderChart(7);
updateTrainerMeta();
</script>
</body>
</html>
